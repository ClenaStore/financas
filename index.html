<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no, minimal-ui">

<title>Financeiro ‚Ä¢ Grupo DV</title>

<!-- ========= PWA ======== -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="https://i.imgur.com/9M1IR7Z.png">

<!-- ========= FONTE ======== -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- ========= ESTILO ======== -->
<style>
:root {
  --azul:#0b1e39;
  --azul2:#152b4e;
  --gold:#d4af37;
  --bg:#f3f5f7;
  --radius:20px;
  --shadow:0 8px 25px rgba(0,0,0,0.18);
}

body {
  font-family:'Inter', sans-serif;
  margin:0;
  background:var(--bg);
  color:#111;
}

header {
  background:var(--azul);
  padding:22px;
  text-align:center;
  color:white;
  font-size:22px;
  font-weight:700;
  box-shadow:var(--shadow);
  border-bottom-left-radius:25px;
  border-bottom-right-radius:25px;
}

/* Carregamento */
#overlay {
  position:fixed;
  inset:0;
  background:white;
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  font-weight:700;
  color:var(--azul);
}

/* Dashboard */
.section-title {
  margin:20px;
  margin-bottom:10px;
  font-size:20px;
  font-weight:700;
  color:var(--azul);
}

.dashboard {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  padding:20px;
}

.card {
  background:white;
  padding:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  text-align:center;
}

.card h3 {
  font-size:15px;
  margin:0;
  color:var(--azul);
}

.card p {
  margin-top:10px;
  font-size:22px;
  font-weight:700;
  color:var(--gold);
}

/* Bot√µes flutuantes */
.menu-floating {
  position:fixed;
  bottom:20px;
  right:20px;
  display:flex;
  flex-direction:column;
  gap:12px;
}

.action-btn {
  padding:16px;
  background:var(--azul);
  color:white;
  font-size:16px;
  border-radius:50px;
  box-shadow:var(--shadow);
  text-align:center;
  width:58px;
  height:58px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}

/* Se√ß√µes */
.section {
  margin:20px;
  background:white;
  padding:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

label {
  font-weight:600;
  margin-top:15px;
  display:block;
}

input, select {
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #ccc;
  margin-top:6px;
  font-size:15px;
}

button {
  width:100%;
  margin-top:20px;
  padding:14px;
  background:var(--azul);
  color:white;
  font-size:16px;
  font-weight:600;
  border:0;
  border-radius:12px;
  cursor:pointer;
  box-shadow:var(--shadow);
}

button:hover {
  background:var(--azul2);
}

/* Lista */
.item {
  background:white;
  padding:16px;
  border-radius:16px;
  margin-bottom:12px;
  box-shadow:var(--shadow);
}

.item h4 {
  margin:0;
  font-size:16px;
  color:var(--azul);
}

.item span { display:block; margin-top:6px; }

/* Gr√°ficos */
canvas {
  width:100% !important;
  max-height:260px;
}

</style>
</head>

<body>

<div id="overlay">Carregando...</div>

<header>Financeiro ‚Ä¢ Grupo DV</header>

<!-- DASHBOARD -->
<div class="section-title">Dashboard Geral</div>
<section class="dashboard">
  <div class="card">
    <h3>Receitas (M√™s)</h3>
    <p id="receitaMes">R$ 0,00</p>
  </div>
  <div class="card">
    <h3>Despesas (M√™s)</h3>
    <p id="despesaMes">R$ 0,00</p>
  </div>
  <div class="card">
    <h3>Saldo</h3>
    <p id="saldoMes">R$ 0,00</p>
  </div>
  <div class="card">
    <h3>Lan√ßamentos</h3>
    <p id="totalLanc">0</p>
  </div>
</section>

<!-- GR√ÅFICO DE BARRAS -->
<div class="section">
  <h3 style="color:var(--azul); margin-top:0;">Gr√°fico Mensal</h3>
  <canvas id="graficoMes"></canvas>
</div>

<!-- GR√ÅFICO DE PIZZA -->
<div class="section">
  <h3 style="color:var(--azul); margin-top:0;">Categorias (Pizza)</h3>
  <canvas id="graficoPizza"></canvas>
</div>

<!-- FORMUL√ÅRIO -->
<div class="section">
  <h2 style="margin-top:0; color:var(--azul);">Novo Lan√ßamento</h2>

  <label>Categoria</label>
  <select id="categoria"></select>

  <label>Tipo</label>
  <select id="tipo">
    <option value="receita">Receita</option>
    <option value="despesa">Despesa</option>
  </select>

  <label>Descri√ß√£o</label>
  <input type="text" id="descricao">

  <label>Valor</label>
  <input type="number" id="valor" step="0.01">

  <label>Data</label>
  <input type="date" id="data">

  <button onclick="salvarLancamento()">Salvar</button>
</div>

<!-- EDITOR DE CATEGORIAS -->
<div class="section">
  <h2 style="margin-top:0; color:var(--azul);">Categorias</h2>

  <label>Nova categoria</label>
  <input id="novaCategoria" type="text">

  <select id="novoTipo">
    <option value="receita">Receita</option>
    <option value="despesa">Despesa</option>
  </select>

  <button onclick="addCategoria()">Adicionar Categoria</button>

  <div id="listaCategorias" style="margin-top:20px;"></div>
</div>

<!-- LISTA -->
<div class="section">
  <h2 style="margin-top:0; color:var(--azul);">Lan√ßamentos</h2>
  <div id="lista"></div>
</div>

<!-- BOT√ïES FLUTUANTES -->
<div class="menu-floating">
  <div class="action-btn" onclick="window.scrollTo({top:0,behavior:'smooth'});">‚Üë</div>
  <div class="action-btn" onclick="gerarTabelaAnual()">üìä</div>
</div>

<!-- ========== SCRIPTS ========== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const API = "URL_DO_SEU_WEBAPP"; // coloque sua URL AQUI

/* INICIALIZA√á√ÉO */
window.onload = async () => {
  await carregarCategorias();
  await carregarLancamentos();
  document.getElementById("overlay").style.display = "none";
};

/* CATEGORIAS */
async function carregarCategorias() {
  const r = await fetch(API + "?action=listaCategorias");
  const dados = await r.json();

  const sel = document.getElementById("categoria");
  sel.innerHTML = "";

  const lista = document.getElementById("listaCategorias");
  lista.innerHTML = "";

  dados.forEach(c => {
    let opt = document.createElement("option");
    opt.value = c.categoria;
    opt.textContent = c.categoria;
    sel.appendChild(opt);

    lista.innerHTML += `
      <div class='item'>
        <h4>${c.categoria}</h4>
        <span>Tipo: ${c.tipo}</span>
      </div>
    `;
  });
}

async function addCategoria() {
  const categoria = document.getElementById("novaCategoria").value;
  const tipo = document.getElementById("novoTipo").value;

  if (!categoria.trim()) {
    alert("Nome inv√°lido");
    return;
  }

  await fetch(API, {
    method:"POST",
    body:JSON.stringify({
      action:"addCategoria",
      categoria,
      tipo
    })
  });

  document.getElementById("novaCategoria").value = "";
  carregarCategorias();
}

/* LAN√áAMENTOS */
async function salvarLancamento() {
  const payload = {
    action: "addLancamento",
    categoria: document.getElementById("categoria").value,
    tipo: document.getElementById("tipo").value,
    descricao: document.getElementById("descricao").value,
    valor: parseFloat(document.getElementById("valor").value),
    data: document.getElementById("data").value
  };

  await fetch(API, { method: "POST", body: JSON.stringify(payload) });

  document.getElementById("descricao").value = "";
  document.getElementById("valor").value = "";
  document.getElementById("data").value = "";
  carregarLancamentos();
}

let graficoMes, graficoPizza;

/* CARREGAR LAN√áAMENTOS */
async function carregarLancamentos() {
  const r = await fetch(API + "?action=listaLancamentos");
  const dados = await r.json();

  let html = "";
  let receitas = 0;
  let despesas = 0;

  let mes = new Array(12).fill(0);
  let categoriasPizza = {};

  dados.forEach(l => {
    html += `
      <div class="item">
        <h4>${l.descricao}</h4>
        <span><b>Categoria:</b> ${l.categoria}</span>
        <span><b>Tipo:</b> ${l.tipo}</span>
        <span><b>Valor:</b> R$ ${Number(l.valor).toFixed(2)}</span>
        <span><b>Data:</b> ${l.data}</span>
      </div>
    `;

    const valor = Number(l.valor);
    const dt = new Date(l.data);
    const m = dt.getMonth();

    if (l.tipo === "receita") receitas += valor;
    else despesas += valor;

    mes[m] += valor;

    if (!categoriasPizza[l.categoria]) categoriasPizza[l.categoria] = 0;
    categoriasPizza[l.categoria] += valor;
  });

  document.getElementById("lista").innerHTML = html;

  document.getElementById("receitaMes").innerText = "R$ " + receitas.toFixed(2);
  document.getElementById("despesaMes").innerText = "R$ " + despesas.toFixed(2);
  document.getElementById("saldoMes").innerText = "R$ " + (receitas - despesas).toFixed(2);
  document.getElementById("totalLanc").innerText = dados.length;

  montarGraficoMes(mes);
  montarGraficoPizza(categoriasPizza);
}

/* GR√ÅFICOS */
function montarGraficoMes(mes) {
  const ctx = document.getElementById("graficoMes");

  if (graficoMes) graficoMes.destroy();

  graficoMes = new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"],
      datasets: [{
        label:"Valores",
        data: mes,
        backgroundColor:"#0b1e39"
      }]
    }
  });
}

function montarGraficoPizza(cat) {
  const ctx = document.getElementById("graficoPizza");

  if (graficoPizza) graficoPizza.destroy();

  graficoPizza = new Chart(ctx, {
    type:"pie",
    data:{
      labels: Object.keys(cat),
      datasets:[{
        data:Object.values(cat),
        backgroundColor:[
          "#0b1e39","#152b4e","#d4af37","#567","#999","#c2a","#829","#665","#baa"
        ]
      }]
    }
  });
}

/* GERAR TABELA ANUAL */
async function gerarTabelaAnual() {
  await fetch(API + "?action=gerarTabelaAnual");
  alert("Tabela anual atualizada!");
}

</script>

</body>
</html>
