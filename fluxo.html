<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Fluxo de Caixa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --azul:#1F4E78;
  --verde:#2ECC71;
  --vermelho:#E74C3C;
  --bg:#f4f6f9;
  --radius:12px;
  --shadow:0 4px 12px rgba(0,0,0,0.15);
}

body{
  margin:0;
  padding:25px;
  background:var(--bg);
  font-family:Arial, sans-serif;
}

h1{
  font-size:32px;
  color:var(--azul);
  margin-bottom:20px;
}

table{
  width:100%;
  background:white;
  border-collapse:collapse;
  overflow:hidden;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

thead{
  background:var(--azul);
  color:white;
}

th,td{
  padding:13px;
  font-size:16px;
}

tbody tr:nth-child(even){
  background:#edf3ff;
}

.valorPositivo{ color:var(--verde); font-weight:bold; }
.valorNegativo{ color:var(--vermelho); font-weight:bold; }

/* loading */
#loading{
  position:fixed;
  bottom:20px;
  left:20px;
  background:#1F4E78;
  padding:12px 22px;
  border-radius:14px;
  color:white;
  display:none;
  animation:pulse 1.2s infinite;
  z-index:999;
}

@keyframes pulse{
  0%{ opacity:.5; transform:scale(.95);}
  50%{opacity:1; transform:scale(1);}
  100%{opacity:.5; transform:scale(.95);}
}
</style>
</head>

<body>

<div id="loading">Carregando fluxo...</div>

<h1>Fluxo de Caixa</h1>

<table>
  <thead>
    <tr>
      <th>Mês</th>
      <th>Receitas</th>
      <th>Despesas</th>
      <th>Saldo Mensal</th>
      <th>Saldo Acumulado</th>
    </tr>
  </thead>
  <tbody id="tabelaFluxo"></tbody>
</table>

<script>
const API = "https://script.google.com/macros/s/AKfycby8xeHkE0EwpMaVPOL6ggjgGasnMVa3piNIr6lCH8MdD7OZEsDA3-b5EjisScjfNLJGMw/exec";

function load(v){
  document.getElementById("loading").style.display = v ? "flex" : "none";
}
function fmt(v){
  return Number(v).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

/* ===============================
     CONVERTER DATA
================================*/
function parseData(dataStr){
  if(!dataStr) return new Date("2000-01-01");

  // Caso venha 2024-10-15
  if(dataStr.includes("-")){
    return new Date(dataStr);
  }

  // Caso venha 15/10/2024
  let p = dataStr.split("/");
  return new Date(p[2], p[1]-1, p[0]);
}

/* ===============================
     CARREGAR LANÇAMENTOS
================================*/
async function carregarFluxo(){
  load(true);

  try{
    let r = await fetch(API+"?action=listLancamentos");
    let dados = await r.json();
    montarFluxo(dados);

  }catch(e){
    alert("Erro ao carregar fluxo: " + e);
  }

  load(false);
}

/* ===============================
     MONTAR FLUXO
================================*/
function montarFluxo(lanc){
  let meses = {};

  lanc.forEach(l => {
    let data = parseData(l[1]);
    let mes = String(data.getMonth()+1).padStart(2,"0") + "/" + data.getFullYear();

    let tipo = l[2];
    let valor = Number(l[6]);

    if(!meses[mes]){
      meses[mes] = { r:0, d:0 };
    }

    if(tipo === "Receita") meses[mes].r += valor;
    else meses[mes].d += valor;
  });

  // ordenar meses
  let ordenado = Object.keys(meses).sort((a,b)=>{
    let pa = a.split("/");
    let pb = b.split("/");
    return new Date(pa[1],pa[0]-1) - new Date(pb[1],pb[0]-1);
  });

  let html = "";
  let acumulado = 0;

  ordenado.forEach(m => {
    let r = meses[m].r;
    let d = meses[m].d;
    let sm = r - d;

    acumulado += sm;

    html += `
      <tr>
        <td>${m}</td>
        <td class="valorPositivo">${fmt(r)}</td>
        <td class="valorNegativo">${fmt(d)}</td>
        <td class="${sm>=0?'valorPositivo':'valorNegativo'}">${fmt(sm)}</td>
        <td class="${acumulado>=0?'valorPositivo':'valorNegativo'}">${fmt(acumulado)}</td>
      </tr>`;
  });

  document.getElementById("tabelaFluxo").innerHTML = html;
}

/* iniciar */
carregarFluxo();
</script>

</body>
</html>
