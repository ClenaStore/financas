<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Financeiro • Cadastros</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --azul:#1F4E78;
  --azul-escuro:#12375A;
  --bg:#f4f6f9;
  --card:#ffffff;
  --texto:#222;
  --radius:12px;
  --shadow:0 6px 20px rgba(0,0,0,0.15);
}

body{
  margin:0;
  font-family: Arial, sans-serif;
  background:var(--bg);
}

/* ======== LAYOUT ======== */
.container{
  padding:30px;
  max-width:1200px;
  margin:auto;
}

h2{
  color:var(--azul);
  font-size:32px;
}

.btn{
  background:#28a745;
  padding:12px 18px;
  border-radius:8px;
  color:white;
  text-decoration:none;
  font-size:16px;
  cursor:pointer;
  display:inline-block;
  margin-bottom:20px;
}

.alert{
  padding:15px;
  border-radius:8px;
  margin-bottom:20px;
  color:white;
  font-size:16px;
}

.alert-erro{ background:#c62828; }
.alert-ok{ background:#2e7d32; }

table{
  width:100%;
  background:white;
  border-collapse:collapse;
  border-radius:12px;
  overflow:hidden;
  box-shadow:var(--shadow);
}

th{
  background:var(--azul-escuro);
  color:white;
  padding:14px;
  text-align:left;
}

td{
  padding:14px;
  border-bottom:1px solid #ddd;
}

tr:hover{
  background:#eef5ff;
}

.acoes button{
  padding:6px 12px;
  border:0;
  border-radius:6px;
  cursor:pointer;
  color:white;
}

.btn-editar{ background:#0277bd; }
.btn-excluir{ background:#c62828; }

#loading{
  position:fixed;
  top:0;
  left:0;
  width:100vw;
  height:100vh;
  background:rgba(0,0,0,0.55);
  display:flex;
  justify-content:center;
  align-items:center;
  color:white;
  font-size:30px;
  z-index:9999;
  display:none;
}
</style>
</head>

<body>

<div id="loading">Carregando...</div>

<div class="container">
  <h2>Cadastros</h2>

  <div id="msg"></div>

  <button class="btn" onclick="novoCadastro()">+ Novo Cadastro</button>

  <table>
    <thead>
      <tr>
        <th>Tipo</th>
        <th>Categoria</th>
        <th>Subcategoria</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyInCpy_Ln1XQhcnbsfPHRimjx0frnOQDRgAyPtraKw_scr7uXP631SUyQZpIlUSi7IMA/exec";

/* ======================== CARREGAR CADASTROS ======================== */
async function carregarCadastros(){
  mostrarLoading(true);
  try{
    let r = await fetch(API + "?action=listCadastros");
    let json = await r.json();

    console.log("RETORNO GAS:", json);

    if(!Array.isArray(json)){
      throw new Error("Retorno inesperado do servidor");
    }

    renderTabela(json);

  }catch(err){
    erro("Falha ao carregar cadastros: " + err.message);
  }
  mostrarLoading(false);
}

/* ======================== RENDERIZAR ======================== */
function renderTabela(lista){
  const tbody = document.getElementById("lista");
  tbody.innerHTML = "";

  lista.forEach(item => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${item[1]}</td>
      <td>${item[2]}</td>
      <td>${item[3]}</td>
      <td class="acoes">
        <button class="btn-editar" onclick="editar('${item[0]}')">Editar</button>
        <button class="btn-excluir" onclick="excluir('${item[0]}')">Excluir</button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

/* ======================== NOVO CADASTRO ======================== */
async function novoCadastro(){
  let tipo = prompt("Tipo (Receita / Despesa):");
  if(!tipo) return;

  let categoria = prompt("Categoria:");
  if(!categoria) return;

  let sub = prompt("Subcategoria:");
  if(!sub) return;

  mostrarLoading(true);

  try{
    let url = API + `?action=createCadastro&tipo=${encodeURIComponent(tipo)}&categoria=${encodeURIComponent(categoria)}&subcategoria=${encodeURIComponent(sub)}`;
    let r = await fetch(url);
    let json = await r.json();

    if(json.erro) throw new Error(json.erro);

    ok("Cadastro criado!");
    carregarCadastros();

  }catch(err){
    erro("Erro ao criar cadastro: " + err.message);
  }

  mostrarLoading(false);
}

/* ======================== EDITAR ======================== */
async function editar(id){
  let tipo = prompt("Novo tipo:");
  if(!tipo) return;

  let categoria = prompt("Nova categoria:");
  if(!categoria) return;

  let sub = prompt("Nova subcategoria:");
  if(!sub) return;

  mostrarLoading(true);

  try{
    let url = API + `?action=editCadastro&id=${id}&tipo=${encodeURIComponent(tipo)}&categoria=${encodeURIComponent(categoria)}&subcategoria=${encodeURIComponent(sub)}`;
    let r = await fetch(url);
    let json = await r.json();

    if(json.erro) throw new Error(json.erro);

    ok("Cadastro atualizado!");
    carregarCadastros();

  }catch(err){
    erro("Erro ao editar: " + err.message);
  }

  mostrarLoading(false);
}

/* ======================== EXCLUIR ======================== */
async function excluir(id){
  if(!confirm("Excluir cadastro?")) return;

  mostrarLoading(true);

  try{
    let url = API + `?action=deleteCadastro&id=${id}`;
    let r = await fetch(url);
    let json = await r.json();

    if(json.erro) throw new Error(json.erro);

    ok("Cadastro excluído!");
    carregarCadastros();

  }catch(err){
    erro("Erro ao excluir: " + err.message);
  }

  mostrarLoading(false);
}

/* ======================== MENSAGENS ======================== */
function erro(msg){
  document.getElementById("msg").innerHTML =
    `<div class='alert alert-erro'>❌ ${msg}</div>`;
}

function ok(msg){
  document.getElementById("msg").innerHTML =
    `<div class='alert alert-ok'>✔ ${msg}</div>`;
}

/* ======================== LOADING ======================== */
function mostrarLoading(v){
  document.getElementById("loading").style.display = v ? "flex" : "none";
}

/* ======================== INICIAR ======================== */
carregarCadastros();
</script>

</body>
</html>
