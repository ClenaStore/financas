<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cadastros • Financeiro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --azul:#1F4E78;
  --azul-escuro:#12375A;
  --bg:#f4f6f9;
  --card:#ffffff;
  --texto:#222;
  --radius:12px;
  --shadow:0 6px 20px rgba(0,0,0,0.15);
}

body{
  margin:0;
  font-family: Arial, sans-serif;
  background:var(--bg);
  display:flex;
}

/* SIDEBAR */
#sidebar{
  width:270px;
  height:100vh;
  background:var(--azul);
  color:white;
  padding-top:30px;
  position:relative;
  transition:0.3s;
  overflow:hidden;
}

#sidebar.recolhido{ width:70px; }

#toggleSidebar{
  position:absolute;
  top:15px;
  right:-20px;
  width:40px;
  height:40px;
  border-radius:50%;
  background:white;
  border:none;
  color:var(--azul);
  font-size:20px;
  cursor:pointer;
  box-shadow:0 5px 15px rgba(0,0,0,0.3);
}

/* Menu lateral */
#sidebar h1{
  text-align:center;
  margin:0;
  margin-bottom:35px;
  font-size:24px;
  transition:0.3s;
}
#sidebar.recolhido h1{ opacity:0; }

.menu-btn{
  display:flex;
  align-items:center;
  gap:12px;
  padding:18px 22px;
  color:white;
  text-decoration:none;
  font-size:17px;
  border-bottom:1px solid rgba(255,255,255,0.10);
}
.menu-btn:hover{ background:var(--azul-escuro); padding-left:30px; }

/* Ícones */
.menu-icon{
  width:22px;
  height:22px;
  background:white;
  border-radius:4px;
}
#sidebar.recolhido .menu-text{ opacity:0; width:0; overflow:hidden; }

/* Conteúdo */
#conteudo{
  flex:1;
  padding:40px;
  overflow-y:auto;
}

.card{
  background:white;
  padding:25px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

/* Tabela */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:25px;
}
th{
  background:var(--azul);
  color:white;
  padding:12px;
}
td{
  padding:12px;
  border-bottom:1px solid #ddd;
  background:white;
}

/* Botões */
.btn{ padding:10px 16px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
.btn-green{ background:#4CAF50; color:white; }
.btn-blue{ background:var(--azul); color:white; }
.btn-red{ background:#C62828; color:white; }

/* Modal */
#modal{
  position:fixed; inset:0; background:#0007;
  display:none; align-items:center; justify-content:center; z-index:999;
}
.modal-box{
  background:white; padding:25px; width:95%; max-width:420px;
  border-radius:12px; box-shadow:var(--shadow);
}
.modal-box h2{ color:var(--azul); }

/* Inputs */
input, select{
  width:100%; padding:12px;
  border-radius:8px; border:1px solid #ccc;
  margin-top:10px;
}

/* Loading */
#overlay{
  position:fixed; inset:0; background:#0007;
  display:none; align-items:center; justify-content:center;
  color:white; font-size:22px; z-index:9999;
}

/* Mensagem de erro */
#errorBox{
  padding:15px;
  background:#C62828;
  color:white;
  border-radius:8px;
  display:none;
  margin-top:10px;
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div id="sidebar">
  <button id="toggleSidebar" onclick="toggleSidebar()">☰</button>

  <h1>FINANCEIRO</h1>

  <a class="menu-btn" href="index.html"><div class="menu-icon"></div><span class="menu-text">Início</span></a>
  <a class="menu-btn" href="cadastros.html"><div class="menu-icon"></div><span class="menu-text">Cadastros</span></a>
  <a class="menu-btn" href="lancamentos.html"><div class="menu-icon"></div><span class="menu-text">Lançamentos</span></a>
  <a class="menu-btn" href="fluxo.html"><div class="menu-icon"></div><span class="menu-text">Fluxo de Caixa</span></a>
  <a class="menu-btn" href="dashboard.html"><div class="menu-icon"></div><span class="menu-text">Dashboard</span></a>
  <a class="menu-btn" href="historico.html"><div class="menu-icon"></div><span class="menu-text">Histórico</span></a>
</div>

<!-- CONTEÚDO -->
<div id="conteudo">
  <div class="card">
    <h1>Cadastros</h1>

    <div id="errorBox"></div>

    <button class="btn btn-green" onclick="abrirModal()">+ Novo Cadastro</button>

    <table>
      <thead>
        <tr>
          <th>Tipo</th>
          <th>Categoria</th>
          <th>Subcategoria</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tabelaCadastros"></tbody>
    </table>
  </div>
</div>

<!-- MODAL -->
<div id="modal">
  <div class="modal-box">
    <h2 id="modalTitulo">Novo Cadastro</h2>

    <input type="hidden" id="editId">

    <label>Tipo</label>
    <select id="tipo">
      <option value="Receita">Receita</option>
      <option value="Despesa">Despesa</option>
    </select>

    <label>Categoria</label>
    <input type="text" id="categoria">

    <label>Subcategoria</label>
    <input type="text" id="subcategoria">

    <br><br>
    <button class="btn btn-blue" onclick="salvarCadastro()">Salvar</button>
    <button class="btn btn-red" onclick="fecharModal()">Cancelar</button>
  </div>
</div>

<div id="overlay">Carregando...</div>

<script>
/* CONFIG */
const API = "https://script.google.com/macros/s/AKfycbyInCpy_Ln1XQhcnbsfPHRimjx0frnOQDRgAyPtraKw_scr7uXP631SUyQZpIlUSi7IMA/exec";

/* SIDEBAR */
function toggleSidebar(){
  document.getElementById("sidebar").classList.toggle("recolhido");
}

/* LOADING */
function overlay(v){
  document.getElementById("overlay").style.display = v ? "flex" : "none";
}

/* ERRO */
function mostrarErro(msg){
  let box = document.getElementById("errorBox");
  box.innerHTML = msg;
  box.style.display = "block";
}

/* LISTAR COM TRATAMENTO DE ERROS */
async function carregarCadastros(){
  overlay(true);
  mostrarErro(""); // limpa erros

  try{

    const controller = new AbortController();
    setTimeout(()=>controller.abort(), 15000); // TIMEOUT 15s

    const r = await fetch(API+"?action=listCadastros", {
      signal: controller.signal
    });

    if(!r.ok) throw new Error("Erro ao conectar com o servidor");

    const dados = await r.json();

    if(!dados || dados.length === 0){
      document.getElementById("tabelaCadastros").innerHTML = `
        <tr><td colspan='4'>Nenhum cadastro encontrado</td></tr>
      `;
      overlay(false);
      return;
    }

    let html = "";

    dados.forEach(l => {
      html += `
        <tr>
          <td>${l[1]}</td>
          <td>${l[2]}</td>
          <td>${l[3]}</td>
          <td>
            <button class="btn btn-blue" onclick="editarCadastro('${l[0]}','${l[1]}','${l[2]}','${l[3]}')">Editar</button>
            <button class="btn btn-red" onclick="excluirCadastro('${l[0]}')">Excluir</button>
          </td>
        </tr>`;
    });

    document.getElementById("tabelaCadastros").innerHTML = html;

  } catch(err){
    console.error("ERRO:", err);
    mostrarErro("❌ Falha ao carregar cadastros:<br>" + err.message);
  }

  overlay(false);
}

/* MODAL */
function abrirModal(){
  document.getElementById("modalTitulo").innerText = "Novo Cadastro";
  document.getElementById("editId").value = "";
  document.getElementById("tipo").value = "Receita";
  document.getElementById("categoria").value = "";
  document.getElementById("subcategoria").value = "";
  document.getElementById("modal").style.display = "flex";
}

function fecharModal(){
  document.getElementById("modal").style.display = "none";
}

/* EDITAR */
function editarCadastro(id, tipo, categoria, sub){
  document.getElementById("modalTitulo").innerText = "Editar Cadastro";
  document.getElementById("editId").value = id;
  document.getElementById("tipo").value = tipo;
  document.getElementById("categoria").value = categoria;
  document.getElementById("subcategoria").value = sub;
  document.getElementById("modal").style.display = "flex";
}

/* SALVAR */
async function salvarCadastro(){
  overlay(true);

  const id = document.getElementById("editId").value;
  const tipo = document.getElementById("tipo").value;
  const categoria = document.getElementById("categoria").value;
  const sub = document.getElementById("subcategoria").value;

  try{
    let url = API + (id
      ? `?action=editCadastro&id=${id}&tipo=${tipo}&categoria=${categoria}&subcategoria=${sub}`
      : `?action=createCadastro&tipo=${tipo}&categoria=${categoria}&subcategoria=${sub}`
    );

    const r = await fetch(url);
    if(!r.ok) throw new Error("Erro ao salvar no servidor");

  }catch(e){
    mostrarErro("❌ Erro ao salvar: " + e.message);
  }

  fecharModal();
  carregarCadastros();
  overlay(false);
}

/* EXCLUIR */
async function excluirCadastro(id){
  if(!confirm("Excluir cadastro?")) return;

  overlay(true);

  try{
    const r = await fetch(API+`?action=deleteCadastro&id=${id}`);
    if(!r.ok) throw new Error("Erro ao excluir");
  }catch(e){
    mostrarErro("❌ Erro ao excluir: " + e.message);
  }

  carregarCadastros();
  overlay(false);
}

/* INICIAR */
carregarCadastros();
</script>

</body>
</html>
