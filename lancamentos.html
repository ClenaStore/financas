<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Financeiro • Calendário Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ================================
   PALETA PREMIUM – AZUL + DOURADO
================================ */
:root{
  --azul:#0b1e39;
  --azul-escuro:#091627;
  --dourado:#c9a86c;
  --dourado-claro:#e2c78c;

  --green:#2ecc71;
  --orange:#ff9f43;
  --red:#e74c3c;

  --bg:#f4f6f9;
  --card:#ffffff;
  --shadow:0 8px 26px rgba(0,0,0,0.15);
  --radius:18px;
}

/* BASE */
body{
  margin:0;
  padding:20px;
  background:var(--bg);
  font-family:Arial, sans-serif;
  color:#222;
}

h1{
  color:var(--azul);
  text-align:center;
  font-size:36px;
  margin-bottom:25px;
  font-weight:800;
}

/* GRID ANUAL */
#ano{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap:25px;
  margin-top:20px;
}

/* CARD DO MÊS */
.card-mes{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px 20px;
  cursor:pointer;
  transition:.2s;
  border:2px solid var(--azul);
}
.card-mes:hover{
  transform:scale(1.02);
}

/* TÍTULO DO MÊS */
.card-mes h2{
  margin:0;
  font-size:22px;
  color:var(--azul);
  font-weight:700;
}

/* RESUMO FINANCEIRO */
.resumo-mes{
  margin-top:12px;
  font-size:15px;
  line-height:1.55;
}
.resumo-mes span{
  display:block;
  margin-top:4px;
}

/* POPUP CENTRAL */
#popup-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99999;
  backdrop-filter:blur(3px);
}

.popup{
  width:650px;
  max-height:90vh;
  overflow-y:auto;
  background:white;
  padding:22px 26px;
  border-radius:22px;
  box-shadow:0 18px 48px rgba(0,0,0,0.35);
  animation:pop .25s ease;
}

@keyframes pop{
  from{transform:scale(.85); opacity:.3;}
  to{transform:scale(1); opacity:1;}
}

.popup h2{
  margin:0 0 12px 0;
  font-size:26px;
  color:var(--azul);
  text-align:center;
}

/* CALENDÁRIO MENSAL */
.grid-mes{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:7px;
  margin-top:15px;
}

.dia{
  background:white;
  border-radius:16px;
  padding:10px;
  min-height:95px;
  box-shadow:0 4px 16px rgba(0,0,0,0.07);
  cursor:pointer;
  transition:.2s;
  border:1px solid #eee;
}
.dia:hover{
  transform:scale(1.05);
  border-color:var(--dourado);
}

.dia-num{
  font-weight:700;
  color:var(--azul);
  font-size:17px;
}

.dia-rec{ font-size:13px; margin-top:5px; color:var(--green); }
.dia-desp{ font-size:13px; color:var(--orange); }
.dia-fech{ margin-top:4px; font-size:13px; font-weight:700; color:var(--azul); }

/* LISTA DE LANÇAMENTOS NO POPUP DO DIA */
.linha{
  background:white;
  padding:14px;
  margin-bottom:10px;
  border-radius:12px;
  border-left:6px solid var(--azul);
  box-shadow:0 4px 18px rgba(0,0,0,0.10);
}

.linha.receita{ border-color:var(--green); }
.linha.despesa{ border-color:var(--orange); }
.linha strong{ font-size:15px; }

/* BOTÕES */
.btn{
  padding:12px 18px;
  border:none;
  border-radius:12px;
  font-size:15px;
  cursor:pointer;
  color:white;
  background:var(--azul);
  margin-top:14px;
  width:100%;
}
.btn:hover{ opacity:.85; }

.btn-gold{
  background:var(--dourado);
  color:var(--azul-escuro);
}
.btn-close{
  background:#666;
}

/* ÍCONES DE STATUS */
.statusIcon{
  font-size:18px;
  margin-right:6px;
}
.passado{ color:var(--green); }
.futuro{ color:var(--red); }

</style>
</head>

<body>

<h1>Calendário Financeiro • 2025</h1>

<div id="ano"></div>

<!-- POPUP GERAL -->
<div id="popup-bg">
  <div class="popup" id="popup"></div>
</div>

<script>
/* =============================================
   CONFIG
============================================= */
const API = "https://script.google.com/macros/s/AKfycby8xeHkE0EwpMaVPOL6ggjgGasnMVa3piNIr6lCH8MdD7OZEsDA3-b5EjisScjfNLJGMw/exec";
let anoAtual = 2025;
let dadosLanc = [];

/* Máscara R$ 1.000,00 */
function maskMoney(v){
  return "R$ "+Number(v).toFixed(2)
        .replace(".",",")
        .replace(/\B(?=(\d{3})+(?!\d))/g,".");
}

/* ================================
   LOCAL STORAGE
================================ */
function carregarLocal(){
  const l = localStorage.getItem("lancamentos");
  if(l) dadosLanc = JSON.parse(l);
}
function salvarLocal(){
  localStorage.setItem("lancamentos", JSON.stringify(dadosLanc));
}

/* ================================
   ATUALIZAÇÃO EM SEGUNDO PLANO
================================ */
async function atualizarBG(){
  try{
    const r = await fetch(API+"?action=listLancamentos");
    const dados = await r.json();
    dadosLanc = dados;
    salvarLocal();
    montarAno();
  }catch(e){}
}
setInterval(atualizarBG, 600000);

/* ================================
   ANO COMPLETO
================================ */
function montarAno(){
  const meses = [
    "Janeiro","Fevereiro","Março","Abril","Maio","Junho",
    "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
  ];

  const ano = document.getElementById("ano");
  ano.innerHTML = "";

  meses.forEach((m,i)=>{
    const card = document.createElement("div");
    card.className="card-mes";
    const mes = i+1;

    const lanc = dadosLanc.filter(l=>{
      const d = new Date(l[1]);
      return d.getFullYear()==anoAtual && (d.getMonth()+1)==mes;
    });

    const rec = lanc.filter(l=>l[2]==="Receita").reduce((t,x)=>t+Number(x[6]),0);
    const desp = lanc.filter(l=>l[2]==="Despesa").reduce((t,x)=>t+Number(x[6]),0);

    card.innerHTML = `
      <h2>${m}</h2>
      <div class="resumo-mes">
        <span style="color:var(--green)">Receitas: ${maskMoney(rec)}</span>
        <span style="color:var(--orange)">Despesas: ${maskMoney(desp)}</span>
        <span style="color:var(--azul); font-weight:700">Fechamento: ${maskMoney(rec-desp)}</span>
      </div>
    `;

    card.onclick = ()=> abrirMesPopup(m, mes);

    ano.appendChild(card);
  });
}

/* ================================
   POPUP DO MÊS
================================ */
function abrirMesPopup(nomeMes, mes){
  const popup = document.getElementById("popup");
  const bg = document.getElementById("popup-bg");

  popup.innerHTML = "";
  bg.style.display = "flex";

  const lancMes = dadosLanc.filter(l=>{
    const d=new Date(l[1]);
    return d.getFullYear()==anoAtual && (d.getMonth()+1)==mes;
  });

  const rec = lancMes.filter(l=>l[2]=="Receita").reduce((t,x)=>t+Number(x[6]),0);
  const desp = lancMes.filter(l=>l[2]=="Despesa").reduce((t,x)=>t+Number(x[6]),0);
  const fech = rec - desp;

  popup.innerHTML = `
    <h2>${nomeMes} de ${anoAtual}</h2>

    <div class="resumo-mes" style="text-align:center; margin-bottom:20px;">
      <span style="color:var(--green)">Receitas: ${maskMoney(rec)}</span>
      <span style="color:var(--orange)">Despesas: ${maskMoney(desp)}</span>
      <span style="color:var(--azul); font-weight:700">Fechamento: ${maskMoney(fech)}</span>
    </div>

    <button class="btn-gold" onclick="novoLancamentoMes(${mes})">+ Novo Lançamento para este mês</button>

    <h3 style="text-align:center; color:var(--azul); margin-top:25px;">Calendário</h3>
    <div id="gridMes"></div>

    <button class="btn-close" onclick="fecharPopup()">Fechar</button>
  `;

  gerarCalendarMes(mes);
}

/* ================================
   CALENDÁRIO DO MÊS
================================ */
function gerarCalendarMes(mes){
  const alvo = document.getElementById("gridMes");
  alvo.className = "grid-mes";
  alvo.innerHTML="";

  const primeiro = new Date(anoAtual, mes-1, 1);
  const ultimo = new Date(anoAtual, mes, 0);

  const inicio = primeiro.getDay();
  const total = ultimo.getDate();

  for(let i=0;i<inicio;i++){
    alvo.appendChild(document.createElement("div"));
  }

  for(let d=1; d<=total; d++){
    const iso = `${anoAtual}-${String(mes).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const diaDiv=document.createElement("div");
    diaDiv.className="dia";

    const lanc = dadosLanc.filter(x=>x[1].startsWith(iso));

    const rec = lanc.filter(l=>l[2]=="Receita").reduce((t,x)=>t+Number(x[6]),0);
    const desp= lanc.filter(l=>l[2]=="Despesa").reduce((t,x)=>t+Number(x[6]),0);

    diaDiv.innerHTML=`
      <div class='dia-num'>${d}</div>
      <div class='dia-rec'>R: ${maskMoney(rec)}</div>
      <div class='dia-desp'>D: ${maskMoney(desp)}</div>
      <div class='dia-fech'>${maskMoney(rec-desp)}</div>
    `;
    diaDiv.onclick = ()=> abrirDiaPopup(iso);

    alvo.appendChild(diaDiv);
  }
}

/* ================================
   POPUP DO DIA
================================ */
function abrirDiaPopup(iso){
  const popup = document.getElementById("popup");
  const bg = document.getElementById("popup-bg");

  popup.innerHTML="";
  bg.style.display="flex";

  const d=new Date(iso);
  const nomeMes=d.toLocaleString("pt-BR",{month:"long"});
  const hoje=new Date();

  popup.innerHTML=`
    <h2>${d.getDate()} de ${nomeMes}</h2>

    <div id="listaDia"></div>

    <button class="btn-gold" onclick="novoLancamentoDia('${iso}')">+ Novo Lançamento</button>
    <button class="btn-close" onclick="fecharPopup()">Fechar</button>
  `;

  const lanc = dadosLanc.filter(x=>x[1].startsWith(iso));
  const lista = document.getElementById("listaDia");

  if(lanc.length==0){
    lista.innerHTML="<p style='text-align:center;color:#777'>Nenhum lançamento.</p>";
  }

  lanc.sort((a,b)=>Number(a[0])-Number(b[0]));

  lanc.forEach(l=>{
    const linha=document.createElement("div");
    linha.className="linha "+(l[2]=="Receita"?"receita":"despesa");

    const dataLanc = new Date(l[1]);
    const status = dataLanc < hoje 
        ? "<span class='statusIcon passado'>✔</span>" 
        : "<span class='statusIcon futuro'>✖</span>";

    linha.innerHTML=`
      ${status}
      <strong>${l[2]}</strong><br>
      Categoria: ${l[3]}<br>
      Sub: ${l[4]}<br>
      Desc: ${l[5]}<br>
      Valor: ${maskMoney(l[6])}
    `;

    lista.appendChild(linha);
  });
}

/* ================================
   LANÇAMENTOS
================================ */
function novoLancamentoMes(mes){
  const data = prompt("Data (AAAA-MM-DD):", `${anoAtual}-${String(mes).padStart(2,"0")}-01`);
  const tipo = prompt("Tipo (Receita/Despesa):");
  const cat = prompt("Categoria:");
  const sub = prompt("Subcategoria:");
  const desc = prompt("Descrição:");
  const val = prompt("Valor:");

  fetch(`${API}?action=createLancamento&data=${data}&tipo=${tipo}&categoria=${cat}&subcategoria=${sub}&descricao=${desc}&valor=${val}`)
    .then(r=>r.json()).then(()=>atualizarBG());
}

function novoLancamentoDia(iso){
  const tipo = prompt("Tipo (Receita/Despesa):");
  const cat = prompt("Categoria:");
  const sub = prompt("Subcategoria:");
  const desc = prompt("Descrição:");
  const val = prompt("Valor:");

  fetch(`${API}?action=createLancamento&data=${iso}&tipo=${tipo}&categoria=${cat}&subcategoria=${sub}&descricao=${desc}&valor=${val}`)
    .then(r=>r.json()).then(()=>atualizarBG());
}

/* ================================
   FECHAR POPUP
================================ */
function fecharPopup(){
  document.getElementById("popup-bg").style.display="none";
}

/* ================================
   INICIAR
================================ */
carregarLocal();
montarAno();
atualizarBG();

</script>

</body>
</html>
