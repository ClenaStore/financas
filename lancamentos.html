<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Financeiro • Lançamentos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ========================= TEMA ======================= */
:root{
  --bg:#eef2f7;
  --card:#ffffff;
  --azul:#0b1e39;
  --azul2:#142840;
  --dourado:#cfa55b;
  --green:#2ecc71;
  --red:#e74c3c;
  --orange:#f39c12;
  --gray:#b8c0cc;
  --shadow:0 9px 28px rgba(0,0,0,.15);
  --radius:18px;
  --radius-sm:12px;
  --transition:.2s ease;
}

/* ======================== BASE ======================= */
body{
  margin:0;
  font-family:'Inter', sans-serif;
  background:var(--bg);
  padding:22px;
  color:#1a1a1a;
  overflow:hidden; /* <<< impede rolagem da página */
}

/* ======================== TÍTULO ======================= */
h1{
  text-align:center;
  color:var(--azul);
  font-size:30px;
  margin:0 0 25px;
  font-weight:700;
}

/* ======================== DASHBOARD ======================= */
.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
  gap:20px;
  margin-bottom:20px;
}

.card{
  background:var(--card);
  padding:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border-left:6px solid var(--dourado);
}

.card h3{
  margin:0;
  font-size:17px;
  color:var(--azul);
}
.card .valor{
  margin-top:10px;
  font-size:26px;
  font-weight:700;
}

/* CARD SALDO → cor automática */
#cardSaldo{
  transition:0.2s;
}

/* ======================== BOTÃO NOVO ======================= */
.btn{
  padding:14px 20px;
  background:var(--azul);
  color:white;
  border:none;
  border-radius:var(--radius-sm);
  font-size:16px;
  cursor:pointer;
  margin-bottom:15px;
  width:100%;
  transition:var(--transition);
}
.btn:hover{ background:var(--azul2); }

/* ======================== FILTROS ======================= */
.filtros{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:15px;
}

select,input[type=month]{
  padding:10px;
  border:1px solid #ccc;
  border-radius:var(--radius-sm);
  font-size:15px;
  width:170px;
}

/* ======================== ÁREA DA TABELA ======================= */
.table-container{
  background:white;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow-y:auto;
  max-height:65vh; /* <<< altura fixa com scroll */
  padding-bottom:10px;
}

/* ======================== TABELA ======================= */
table{
  width:100%;
  border-collapse:collapse;
}

th{
  background:var(--azul);
  color:white;
  padding:12px;
  text-align:left;
  position:sticky;
  top:0;
  z-index:10;
}
td{
  padding:12px;
  border-bottom:1px solid #e4e4e4;
}

.status{
  padding:6px 10px;
  border-radius:10px;
  color:white;
  font-size:13px;
  display:inline-block;
}

.st-pendente{ background:var(--orange); }
.st-recebido{ background:var(--green); }
.st-pago{ background:var(--green); }
.st-vencido{ background:var(--red); }

/* ======================== MODAL ======================= */
#modal-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  backdrop-filter:blur(5px);
  z-index:999;
}

.modal{
  width:420px;
  background:white;
  padding:25px;
  border-radius:var(--radius);
  animation:pop .25s ease;
  box-shadow:0 12px 35px rgba(0,0,0,.35);
}

@keyframes pop{
  from{ transform:scale(.85); opacity:.4; }
  to{ transform:scale(1); opacity:1; }
}

.modal input, .modal select{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border:1px solid #ccc;
  border-radius:var(--radius-sm);
  font-size:15px;
}

/* tipo */
.tipo-group{
  display:flex;
  gap:10px;
  margin-bottom:12px;
}
.tipo-btn{
  flex:1;
  padding:12px;
  text-align:center;
  background:#ddd;
  border-radius:var(--radius-sm);
  cursor:pointer;
}
.tipo-active{
  background:var(--azul);
  color:white;
  font-weight:600;
}

/* ======================== LOADING ======================= */
#loading{
  position:fixed;
  bottom:20px;
  left:20px;
  background:var(--azul);
  color:white;
  padding:12px 20px;
  border-radius:var(--radius-sm);
  display:none;
  animation:pulse 1.2s infinite;
  z-index:999;
}

@keyframes pulse{
  0%{opacity:.6; transform:scale(.95);}
  50%{opacity:1; transform:scale(1);}
  100%{opacity:.6; transform:scale(.95);}
}
</style>
</head>

<body>

<h1>Controle Financeiro</h1>

<!-- LOADING -->
<div id="loading">Carregando...</div>

<!-- DASHBOARD -->
<div class="dashboard">
  <div class="card"><h3>A RECEBER</h3><div class="valor" id="vReceber">R$ 0,00</div></div>
  <div class="card"><h3>A PAGAR</h3><div class="valor" id="vPagar">R$ 0,00</div></div>
  <div class="card"><h3>RECEBIDOS</h3><div class="valor" id="vRecebidos">R$ 0,00</div></div>
  <div class="card"><h3>PAGOS</h3><div class="valor" id="vPagos">R$ 0,00</div></div>

  <!-- NOVO CARD: SALDO ATUAL -->
  <div class="card" id="cardSaldo">
    <h3>SALDO ATUAL</h3>
    <div class="valor" id="vSaldo">R$ 0,00</div>
  </div>
</div>

<!-- BOTÃO -->
<button class="btn" onclick="abrirModal()">+ Novo Lançamento</button>

<!-- FILTROS -->
<div class="filtros">
  <select id="fTipo">
    <option value="">Tipo</option>
    <option value="Receita">Receita</option>
    <option value="Despesa">Despesa</option>
  </select>

  <select id="fStatus">
    <option value="">Status</option>
    <option value="PENDENTE">Pendente</option>
    <option value="RECEBIDO">Recebido</option>
    <option value="PAGO">Pago</option>
    <option value="VENCIDO">Vencido</option>
  </select>

  <input type="month" id="fMes">
</div>

<!-- TABELA COM ROLAGEM -->
<div class="table-container">
<table>
<thead>
<tr>
  <th>Data</th>
  <th>Tipo</th>
  <th>Categoria</th>
  <th>Descrição</th>
  <th>Valor</th>
  <th>Status</th>
  <th>Ações</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>
</div>

<!-- MODAL -->
<div id="modal-bg">
  <div class="modal">

    <h2 id="tituloModal" style="margin-top:0; color:var(--azul);">Novo Lançamento</h2>

    <input id="mData" type="date">

    <div class="tipo-group">
      <div id="btnReceita" class="tipo-btn">Receita</div>
      <div id="btnDespesa" class="tipo-btn">Despesa</div>
    </div>

    <input type="hidden" id="mTipo">

    <input list="listaCat" id="mCat" placeholder="Categoria">
    <datalist id="listaCat"></datalist>

    <input list="listaSub" id="mSub" placeholder="Subcategoria">
    <datalist id="listaSub"></datalist>

    <input id="mDesc" placeholder="Descrição">

    <input id="mValor" placeholder="R$ 0,00">

    <select id="mStatus">
      <option value="PENDENTE">Pendente</option>
      <option value="RECEBIDO">Recebido</option>
      <option value="PAGO">Pago</option>
    </select>

    <button class="btn-salvar" onclick="salvar()">Salvar</button>
    <button class="btn-cancelar" onclick="fecharModal()">Cancelar</button>

  </div>
</div>

<script>
/* ============================= CONFIG API ============================= */
const API = "https://script.google.com/macros/s/AKfycbwj6b0Lpxcl6ELlX5SYO1ZKHmyphG7c4lyHUUVtmeBBuyJtWeyxV23hGl9bU8evYxDBJw/exec";

let DATA_ORIGINAL = []; 
let EDIT_ID = null;

/* ============================= LOADING ============================= */
function load(v){ 
  document.getElementById("loading").style.display = v ? "flex" : "none"; 
}

/* ============================= FORMATADORES ============================= */
function fd(d){
  const dt = new Date(d);
  return dt.toLocaleDateString("pt-BR");
}

function fm(v){
  return Number(v).toLocaleString("pt-BR",{minimumFractionDigits:2});
}

/* ============================= CARREGAR CATEGORIAS ============================= */
async function carregarCategorias(){
  const r = await fetch(API+"?action=listCadastros");
  const dados = await r.json();

  listaCat.innerHTML = [...new Set(dados.map(l=>l[2]))].map(c=>`<option value="${c}">`).join("");
  listaSub.innerHTML = [...new Set(dados.map(l=>l[3]))].map(s=>`<option value="${s}">`).join("");
}

/* ============================= LISTAR LANÇAMENTOS ============================= */
async function listar(){
  load(true);

  const r = await fetch(API+"?action=listLancamentos");
  DATA_ORIGINAL = await r.json();

  aplicarFiltros();

  load(false);
}

/* ============================= APLICAR FILTROS ============================= */
function aplicarFiltros(){
  let tipoF   = fTipo.value;
  let statusF = fStatus.value;
  let mesF    = fMes.value;

  let dados = [...DATA_ORIGINAL];

  if(tipoF){
    dados = dados.filter(l => l[2] === tipoF);
  }

  if(statusF){
    if(statusF === "VENCIDO"){
      dados = dados.filter(l => new Date(l[1]) < new Date() && (l[7] === "PENDENTE" || !l[7]));
    } else {
      dados = dados.filter(l => (l[7] || "PENDENTE") === statusF);
    }
  }

  if(mesF){
    dados = dados.filter(l => String(l[1]).substring(0,7) === mesF);
  }

  renderTabela(dados);
  gerarDashboard(dados);
}

/* ============================= RENDERIZA TABELA ============================= */
function renderTabela(data){
  lista.innerHTML = data.map(l=>{
    const id = l[0];
    const data = fd(l[1]);
    const tipo = l[2];
    const cat = l[3];
    const desc = l[5];
    const valor = fm(l[6]);
    const status = l[7] || "PENDENTE";

    return `
      <tr>
        <td>${data}</td>
        <td>${tipo}</td>
        <td>${cat}</td>
        <td>${desc}</td>
        <td>R$ ${valor}</td>
        <td><span class="status st-${status.toLowerCase()}">${status}</span></td>
        <td>
          <button onclick="editar('${id}')">Editar</button>
          <button onclick="excluir('${id}')">Excluir</button>
        </td>
      </tr>
    `;
  }).join("");
}

/* ============================= DASHBOARD ============================= */
function gerarDashboard(data){
  let aReceber = 0, aPagar = 0, recebidos = 0, pagos = 0;

  data.forEach(l=>{
    const tipo = l[2];
    const valor = Number(l[6]);
    const status = l[7] || "PENDENTE";

    if(tipo==="Receita" && status==="PENDENTE") aReceber += valor;
    if(tipo==="Despesa" && status==="PENDENTE") aPagar += valor;
    if(status==="RECEBIDO") recebidos += valor;
    if(status==="PAGO") pagos += valor;
  });

  vReceber.innerText  = "R$ "+fm(aReceber);
  vPagar.innerText    = "R$ "+fm(aPagar);
  vRecebidos.innerText= "R$ "+fm(recebidos);
  vPagos.innerText    = "R$ "+fm(pagos);

  /* ================== SALDO ATUAL ================== */
  let saldo = (aReceber + recebidos) - (aPagar + pagos);

  vSaldo.innerText = "R$ " + fm(saldo);

  /* COR DO CARD */
  const card = document.getElementById("cardSaldo");

  if(saldo > 0){
    card.style.borderLeftColor = "var(--green)";
  } 
  else if(saldo < 0){
    card.style.borderLeftColor = "var(--red)";
  } 
  else {
    card.style.borderLeftColor = "var(--gray)";
  }
}

/* ============================= MODAL ============================= */
function abrirModal(){
  EDIT_ID = null;

  document.getElementById("modal-bg").style.display="flex";
  tituloModal.innerText="Novo Lançamento";

  mData.value = new Date().toISOString().split("T")[0];
  mTipo.value="";
  mCat.value="";
  mSub.value="";
  mDesc.value="";
  mValor.value="";
  mStatus.value="PENDENTE";

  btnReceita.classList.remove("tipo-active");
  btnDespesa.classList.remove("tipo-active");
}

function fecharModal(){
  document.getElementById("modal-bg").style.display="none";
}

/* ============================= EDITAR ============================= */
function editar(id){
  const lanc = DATA_ORIGINAL.find(l => l[0] == id);
  if(!lanc){ alert("Lançamento não encontrado!"); return; }

  EDIT_ID = id;

  document.getElementById("modal-bg").style.display="flex";
  tituloModal.innerText="Editar Lançamento";

  mData.value  = lanc[1];
  mTipo.value  = lanc[2];
  mCat.value   = lanc[3];
  mSub.value   = lanc[4];
  mDesc.value  = lanc[5];
  mValor.value = String(lanc[6]).replace(".", ",");
  mStatus.value= lanc[7] || "PENDENTE";

  btnReceita.classList.toggle("tipo-active", lanc[2] === "Receita");
  btnDespesa.classList.toggle("tipo-active", lanc[2] === "Despesa");
}

/* ============================= EXCLUIR ============================= */
async function excluir(id){
  if(!confirm("Deseja realmente excluir este lançamento?")) return;

  load(true);
  await fetch(`${API}?action=deleteLancamento&id=${id}`);
  await listar();
  load(false);
}

/* ============================= SALVAR ============================= */
async function salvar(){
  let data   = mData.value;
  let tipo   = mTipo.value;
  let cat    = mCat.value;
  let sub    = mSub.value;
  let desc   = mDesc.value;
  let val    = mValor.value.replace("R$","").replace(".","").replace(",",".").trim();
  let status = mStatus.value;

  let url = "";

  if(EDIT_ID){
    url = `${API}?action=editLancamento&id=${EDIT_ID}&campos=${encodeURIComponent(JSON.stringify({
      data:data, tipo:tipo, categoria:cat, subcategoria:sub,
      descricao:desc, valor:val, status:status
    }))}`;
  } 
  else {
    url = `${API}?action=createLancamento&data=${data}&tipo=${tipo}&categoria=${cat}&subcategoria=${sub}&descricao=${desc}&valor=${val}&status=${status}`;
  }

  load(true);
  await fetch(url);

  fecharModal();
  listar();
  load(false);

  EDIT_ID = null;
}

/* ============================= BOTÕES RECEITA / DESPESA ============================= */
btnReceita.onclick = () => {
  mTipo.value="Receita";
  btnReceita.classList.add("tipo-active");
  btnDespesa.classList.remove("tipo-active");
};

btnDespesa.onclick = () => {
  mTipo.value="Despesa";
  btnDespesa.classList.add("tipo-active");
  btnReceita.classList.remove("tipo-active");
};

/* ============================= FILTROS ============================= */
fTipo.onchange = aplicarFiltros;
fStatus.onchange = aplicarFiltros;
fMes.onchange = aplicarFiltros;

/* ============================= START ============================= */
carregarCategorias();
listar();
</script>

</body>
</html>
