<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Financeiro • Calendário Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ================================
   PALETA PREMIUM – AZUL + DOURADO
================================ */
:root{
  --azul:#0b1e39;
  --azul-escuro:#091627;
  --dourado:#c9a86c;
  --dourado-claro:#e2c78c;

  --green:#2ecc71;
  --orange:#ff9f43;
  --red:#e74c3c;

  --bg:#f4f6f9;
  --card:#ffffff;
  --shadow:0 8px 26px rgba(0,0,0,0.15);
  --radius:18px;
}

/* BASE */
body{
  margin:0;
  padding:20px;
  background:var(--bg);
  font-family:Arial, sans-serif;
  color:#222;
}

h1{
  color:var(--azul);
  text-align:center;
  font-size:36px;
  margin-bottom:25px;
  font-weight:800;
}

/* GRID ANUAL */
#ano{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap:25px;
  margin-top:20px;
}

/* CARD DO MÊS */
.card-mes{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px 20px;
  cursor:pointer;
  transition:.2s;
  border:2px solid var(--azul);
}
.card-mes:hover{
  transform:scale(1.02);
}

/* TÍTULO DO MÊS */
.card-mes h2{
  margin:0;
  font-size:22px;
  color:var(--azul);
  font-weight:700;
}

/* RESUMO FINANCEIRO */
.resumo-mes{
  margin-top:12px;
  font-size:15px;
  line-height:1.55;
}
.resumo-mes span{
  display:block;
  margin-top:4px;
}

/* CALENDÁRIO MENSAL */
.calendario-mes{
  margin-top:22px;
  border-top:2px solid var(--dourado);
  padding-top:18px;
  display:none;
}

.grid-mes{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:7px;
}

/* DIA */
.dia{
  background:white;
  border-radius:14px;
  padding:10px;
  min-height:95px;
  box-shadow:0 4px 16px rgba(0,0,0,0.07);
  cursor:pointer;
  transition:.2s;
  border:1px solid #eee;
}
.dia:hover{
  transform:scale(1.04);
  border-color:var(--dourado);
}

/* NÚMERO DO DIA */
.dia-num{
  font-weight:700;
  color:var(--azul);
  font-size:17px;
}

/* VALORES */
.dia-rec{
  font-size:13px;
  margin-top:5px;
  color:var(--green);
}
.dia-desp{
  font-size:13px;
  color:var(--orange);
}

.dia-fech{
  margin-top:4px;
  font-size:13px;
  font-weight:700;
  color:var(--azul);
}

/* POPUP DIA */
#popup-dia-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  backdrop-filter:blur(3px);
}

.popup-dia{
  width:520px;
  max-height:85vh;
  overflow-y:auto;
  background:white;
  padding:22px;
  border-radius:18px;
  box-shadow:0 14px 40px rgba(0,0,0,0.3);
  animation:pop .25s ease;
}

@keyframes pop{
  from{transform:scale(.85); opacity:.3;}
  to{transform:scale(1); opacity:1;}
}

.popup-dia h2{
  margin:0;
  font-size:22px;
  color:var(--azul);
  text-align:center;
  margin-bottom:15px;
}

/* LANÇAMENTOS DO DIA */
.linha{
  background:#fdfdfd;
  border-radius:12px;
  padding:12px 14px;
  margin-bottom:10px;
  border-left:6px solid var(--azul);
  box-shadow:0 4px 16px rgba(0,0,0,0.08);
}

.linha.receita{ border-color:var(--green); }
.linha.despesa{ border-color:var(--orange); }

.linha strong{ font-size:15px; }

/* BOTÕES */
.btn{
  padding:12px 18px;
  border:none;
  border-radius:12px;
  font-size:15px;
  cursor:pointer;
  color:white;
  background:var(--azul);
  margin-top:10px;
  width:100%;
}
.btn:hover{
  opacity:.85;
}

.btn-gold{
  background:var(--dourado);
  color:var(--azul-escuro);
}
.btn-close{
  background:#888;
  margin-top:14px;
}

</style>
</head>

<body>

<h1>Calendário Financeiro • 2025</h1>

<div id="ano"></div>

<!-- POPUP DO DIA -->
<div id="popup-dia-bg">
  <div class="popup-dia" id="popup-dia">
    <h2 id="tituloDia"></h2>

    <div id="listaDia"></div>

    <button class="btn btn-gold" onclick="novoLancamentoDia()">+ Novo Lançamento</button>
    <button class="btn btn-close" onclick="fecharPopupDia()">Fechar</button>
  </div>
</div>

<script>
/* =============================================
   API + STORAGE + FUNÇÕES GERAIS
============================================= */
const API = "https://script.google.com/macros/s/AKfycby8xeHkE0EwpMaVPOL6ggjgGasnMVa3piNIr6lCH8MdD7OZEsDA3-b5EjisScjfNLJGMw/exec";

let dadosLanc = [];
let dadosCat = [];
let anoAtual = 2025;

/* Máscara R$ 1.000,00 */
function maskMoney(v){
  return "R$ "+Number(v).toFixed(2)
        .replace(".",",")
        .replace(/\B(?=(\d{3})+(?!\d))/g,".");
}

/* Carrega localStorage */
function carregarLocal(){
  const l = localStorage.getItem("lancamentos");
  if(l){ dadosLanc = JSON.parse(l); }
}

/* Salva localStorage */
function salvarLocal(){
  localStorage.setItem("lancamentos", JSON.stringify(dadosLanc));
}

/* Atualizar em segundo plano */
async function atualizarSegundoPlano(){
  try{
    const r = await fetch(API+"?action=listLancamentos");
    const dados = await r.json();
    dadosLanc = dados;
    salvarLocal();
    montarAno();
  }catch(e){ console.log("Erro atualização BG", e); }
}

/* Atuliza a cada 10 min */
setInterval(atualizarSegundoPlano, 600000);

/* =============================================
   ANO COMPLETO
============================================= */
function montarAno(){
  const anoDiv = document.getElementById("ano");
  anoDiv.innerHTML = "";

  const meses = [
    "Janeiro","Fevereiro","Março","Abril","Maio","Junho",
    "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
  ];

  meses.forEach((m,i)=>{
    const card = document.createElement("div");
    card.className="card-mes";
    const indiceMes = i+1;

    const lancMes = dadosLanc.filter(l=>{
      const d = new Date(l[1]);
      return d.getFullYear()==anoAtual && (d.getMonth()+1)==indiceMes;
    });

    const rec = lancMes.filter(l=>l[2]==="Receita")
                       .reduce((t,x)=>t+Number(x[6]),0);
    const desp = lancMes.filter(l=>l[2]==="Despesa")
                        .reduce((t,x)=>t+Number(x[6]),0);

    const fech = rec - desp;

    card.innerHTML = `
      <h2>${m}</h2>
      <div class="resumo-mes">
        <span style="color:var(--green)">Receitas: ${maskMoney(rec)}</span>
        <span style="color:var(--orange)">Despesas: ${maskMoney(desp)}</span>
        <span style="color:var(--azul); font-weight:700;">Fechamento: ${maskMoney(fech)}</span>
      </div>
      <div class="calendario-mes" id="cal-${indiceMes}"></div>
    `;

    card.onclick = ()=> abrirMes(indiceMes);

    anoDiv.appendChild(card);
  });
}

/* =============================================
   CONTINUA NA PRÓXIMA RESPOSTA…
============================================= */
<script>
/* =============================================
   FUNÇÃO PARA ABRIR O MÊS (GERAR CALENDÁRIO)
============================================= */
function abrirMes(mes){
  const alvo = document.getElementById("cal-"+mes);

  // Fecha se já está aberto
  if(alvo.style.display === "block"){
    alvo.style.display = "none";
    alvo.innerHTML = "";
    return;
  }

  // Fecha todos os outros
  document.querySelectorAll(".calendario-mes").forEach(c=>{
    c.style.display="none";
    c.innerHTML="";
  });

  alvo.style.display = "block";

  gerarCalendarioMes(mes, alvo);
}

/* =============================================
   GERAR CALENDÁRIO DO MÊS
============================================= */
function gerarCalendarioMes(mes, alvo){
  alvo.innerHTML = "";

  const nomeMes = [
    "Janeiro","Fevereiro","Março","Abril","Maio","Junho",
    "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
  ][mes-1];

  const titulo = document.createElement("h3");
  titulo.style.color = "var(--azul)";
  titulo.style.margin = "0 0 15px 0";
  titulo.style.textAlign = "center";
  titulo.style.fontSize = "20px";
  titulo.innerText = nomeMes + " de " + anoAtual;

  const grid = document.createElement("div");
  grid.className = "grid-mes";

  const primeiroDia = new Date(anoAtual, mes-1, 1);
  const ultimoDia = new Date(anoAtual, mes, 0);

  const inicioSemana = primeiroDia.getDay();
  const totalDias = ultimoDia.getDate();

  // Espaços vazios antes do dia 1
  for(let i=0;i<inicioSemana;i++){
    const vazio = document.createElement("div");
    grid.appendChild(vazio);
  }

  // Dias do mês
  for(let d=1; d<=totalDias; d++){
    const dataISO = `${anoAtual}-${String(mes).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const diaDiv = document.createElement("div");
    diaDiv.className = "dia";

    const lanc = dadosLanc.filter(x => x[1].startsWith(dataISO));
    const rec = lanc.filter(x=>x[2]==="Receita").reduce((t,x)=>t+Number(x[6]),0);
    const desp = lanc.filter(x=>x[2]==="Despesa").reduce((t,x)=>t+Number(x[6]),0);
    const fech = rec - desp;

    diaDiv.innerHTML = `
      <div class="dia-num">${d}</div>
      <div class="dia-rec">R: ${maskMoney(rec)}</div>
      <div class="dia-desp">D: ${maskMoney(desp)}</div>
      <div class="dia-fech">${maskMoney(fech)}</div>
    `;

    diaDiv.onclick = ()=> abrirDia(dataISO);

    grid.appendChild(diaDiv);
  }

  alvo.appendChild(titulo);
  alvo.appendChild(grid);
}

/* =============================================
   POPUP DO DIA
============================================= */
function abrirDia(dataISO){
  const bg = document.getElementById("popup-dia-bg");
  const listaDia = document.getElementById("listaDia");
  const tituloDia = document.getElementById("tituloDia");

  bg.style.display = "flex";

  const d = new Date(dataISO);
  const nomeMes = d.toLocaleString("pt-BR",{month:"long"});
  tituloDia.innerText = `${d.getDate()} de ${nomeMes} de ${d.getFullYear()}`;

  const lanc = dadosLanc.filter(x=>x[1].startsWith(dataISO));

  listaDia.innerHTML = "";

  if(lanc.length === 0){
    listaDia.innerHTML = `<p style="text-align:center; color:#777;">Nenhum lançamento neste dia.</p>`;
  }

  lanc.sort((a,b)=> Number(a[0]) - Number(b[0]));

  lanc.forEach(l=>{
    const linha = document.createElement("div");
    linha.className = "linha " + (l[2]==="Receita" ? "receita" : "despesa");

    linha.innerHTML = `
      <strong>${l[2]}</strong><br>
      Categoria: ${l[3]}<br>
      Sub: ${l[4]}<br>
      Desc: ${l[5]}<br>
      Valor: ${maskMoney(l[6])}<br><br>
      <button class="btn" onclick="editarLanc('${l[0]}')">Editar</button>
      <button class="btn" style="background:var(--red)" onclick="excluirLanc('${l[0]}','${dataISO}')">Excluir</button>
    `;

    listaDia.appendChild(linha);
  });

  // Salvar dia escolhido
  localStorage.setItem("diaAtual", dataISO);
}

function fecharPopupDia(){
  document.getElementById("popup-dia-bg").style.display = "none";
}

/* =============================================
   NOVO LANÇAMENTO DIRETO DO DIA
============================================= */
function novoLancamentoDia(){
  const dia = localStorage.getItem("diaAtual");
  if(!dia) return alert("Erro ao definir data.");

  const data = prompt("Data:", dia);
  const tipo = prompt("Tipo (Receita / Despesa):");
  const categoria = prompt("Categoria:");
  const sub = prompt("Subcategoria:");
  const desc = prompt("Descrição:");
  const valor = prompt("Valor (EX: 1000.50):");

  if(!data||!tipo||!categoria||!sub||!desc||!valor){
    alert("Preencha todos os campos.");
    return;
  }

  fetch(`${API}?action=createLancamento&data=${data}&tipo=${tipo}&categoria=${categoria}&subcategoria=${sub}&descricao=${desc}&valor=${valor}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status==="ok"){
        atualizarSegundoPlano();
        abrirDia(data);
      }else{
        alert("Erro ao salvar.");
      }
    });
}

/* =============================================
   EDITAR LANÇAMENTO
============================================= */
function editarLanc(id){
  const l = dadosLanc.find(x=>x[0]==id);
  if(!l) return;

  const data = prompt("Data:", l[1]);
  const tipo = prompt("Tipo (Receita / Despesa):", l[2]);
  const categoria = prompt("Categoria:", l[3]);
  const sub = prompt("Subcategoria:", l[4]);
  const desc = prompt("Descrição:", l[5]);
  const valor = prompt("Valor:", l[6]);

  const campos = JSON.stringify({data,tipo,categoria,subcategoria:sub,descricao:desc,valor});

  fetch(`${API}?action=editLancamento&id=${id}&campos=${encodeURIComponent(campos)}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status==="ok"){
        atualizarSegundoPlano();
        abrirDia(data);
      }else{
        alert("Erro ao editar.");
      }
    });
}

/* =============================================
   EXCLUIR LANÇAMENTO
============================================= */
function excluirLanc(id, dia){
  if(!confirm("Excluir lançamento?")) return;

  fetch(`${API}?action=deleteLancamento&id=${id}`)
    .then(r=>r.json())
    .then(j=>{
      atualizarSegundoPlano();
      abrirDia(dia);
    });
}

/* =============================================
   INICIALIZAÇÃO
============================================= */
async function iniciar(){
  carregarLocal();
  montarAno();

  // Atualiza em segundo plano
  atualizarSegundoPlano();
}

iniciar();
</script>

</body>
</html>
