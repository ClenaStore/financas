<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Financeiro • Calendário Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ================================
   PALETA PREMIUM – AZUL + DOURADO
================================ */
:root{
  --azul:#0b1e39;
  --azul-escuro:#091627;
  --dourado:#c9a86c;
  --dourado-claro:#e2c78c;

  --green:#2ecc71;
  --orange:#ff9f43;
  --red:#e74c3c;

  --bg:#f4f6f9;
  --card:#ffffff;
  --shadow:0 8px 26px rgba(0,0,0,0.15);
  --radius:18px;
}

body{
  margin:0;
  padding:25px;
  background:var(--bg);
  font-family:Arial, sans-serif;
  color:#222;
}

h1{
  text-align:center;
  color:var(--azul);
  font-size:34px;
  margin-bottom:25px;
  font-weight:800;
}

/* GRID ANUAL */
#ano{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap:22px;
}

/* CARD DO MÊS */
.card-mes{
  background:var(--card);
  padding:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border:2px solid var(--azul);
  transition:.2s;
  cursor:pointer;
}
.card-mes:hover{
  transform:scale(1.03);
}

.card-mes h2{
  margin:0;
  color:var(--azul);
  font-weight:700;
  text-align:center;
}

.resumo-mes{
  margin-top:12px;
  font-size:15px;
  line-height:1.5;
}
.resumo-mes span{
  display:block;
}

/* POPUP CENTRAL DO MÊS */
#popup-mes-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  backdrop-filter:blur(3px);
}

.popup-mes{
  width:600px;
  max-height:90vh;
  overflow-y:auto;
  background:white;
  padding:25px;
  border-radius:20px;
  box-shadow:0 12px 38px rgba(0,0,0,0.35);
  animation:pop .25s ease;
}

@keyframes pop{
  from{transform:scale(.85); opacity:.3;}
  to{transform:scale(1); opacity:1;}
}

.popup-mes h2{
  text-align:center;
  margin-top:0;
  color:var(--azul);
}

.grid-mes{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;
  margin-top:20px;
}

/* DIA */
.dia{
  background:white;
  padding:10px;
  border-radius:12px;
  box-shadow:0 4px 16px rgba(0,0,0,0.08);
  cursor:pointer;
  min-height:90px;
  transition:.2s;
  border:1px solid #e6e6e6;
}
.dia:hover{
  transform:scale(1.05);
  border-color:var(--dourado);
}

.dia-num{
  font-size:16px;
  font-weight:700;
  color:var(--azul);
}

.dia-rec{ color:var(--green); font-size:13px; margin-top:4px; }
.dia-desp{ color:var(--orange); font-size:13px; }
.dia-fech{ color:var(--azul); font-weight:700; font-size:13px; margin-top:4px; }

/* ==========================================
   POPUP DO DIA
========================================== */
#popup-dia-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  backdrop-filter:blur(3px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99999;
}

.popup-dia{
  width:520px;
  max-height:85vh;
  overflow-y:auto;
  background:white;
  padding:22px;
  border-radius:18px;
  animation:pop .25s ease;
}

.popup-dia h2{
  text-align:center;
  margin-top:0;
  color:var(--azul);
}

/* Lançamentos */
.linha{
  background:#fdfdfd;
  border-radius:12px;
  padding:12px 14px;
  margin-bottom:10px;
  border-left:6px solid var(--azul);
  box-shadow:0 4px 14px rgba(0,0,0,0.08);
}

.linha.receita{ border-color:var(--green); }
.linha.despesa{ border-color:var(--orange); }

.statusIcon{
  font-size:18px;
  margin-right:6px;
}
.passado{ color:var(--green); }  
.futuro{ color:var(--red); }

.btn{
  width:100%;
  padding:13px;
  border:none;
  border-radius:12px;
  margin-top:10px;
  cursor:pointer;
  background:var(--azul);
  color:white;
  font-size:15px;
}
.btn:hover{ opacity:.85; }

.btn-close{
  background:#777;
}

</style>
</head>

<body>

<h1>Calendário Financeiro 2025</h1>
<div id="ano"></div>

<!-- POPUP DO MÊS -->
<div id="popup-mes-bg">
  <div class="popup-mes" id="popupMes"></div>
</div>

<!-- POPUP DO DIA -->
<div id="popup-dia-bg">
  <div class="popup-dia">
    <h2 id="tituloDia"></h2>
    <div id="listaDia"></div>
    <button class="btn" onclick="novoLancamentoDia()">+ Novo Lançamento</button>
    <button class="btn btn-close" onclick="fecharDia()">Fechar</button>
  </div>
</div>

<script>
/* ============================================================
   CONFIG
============================================================ */
const API = "https://script.google.com/macros/s/AKfycby8xeHkE0EwpMaVPOL6ggjgGasnMVa3piNIr6lCH8MdD7OZEsDA3-b5EjisScjfNLJGMw/exec";

let dadosLanc = [];
let anoAtual = 2025;

/* Máscara R$ X.XXX,XX */
function maskMoney(v){
  return "R$ "+Number(v).toFixed(2).replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".");
}

/* Status */
const hoje = new Date();
function getStatusIcon(dataISO){
  const d = new Date(dataISO);
  if(d < hoje) return `<span class="statusIcon passado">✔</span>`;
  return `<span class="statusIcon futuro">✖</span>`;
}

/* ============================================================
   LOCAL STORAGE
============================================================ */
function carregarLocal(){
  const l = localStorage.getItem("lancamentos");
  if(l) dadosLanc = JSON.parse(l);
}

function salvarLocal(){
  localStorage.setItem("lancamentos", JSON.stringify(dadosLanc));
}

/* ============================================================
   ATUALIZAÇÃO EM SEGUNDO PLANO
============================================================ */
async function atualizarSegundoPlano(){
  try{
    const r = await fetch(API+"?action=listLancamentos");
    const dados = await r.json();
    dadosLanc = dados;
    salvarLocal();
    montarAno();
  }catch(e){ console.log("Erro atualização BG:", e); }
}

setInterval(atualizarSegundoPlano, 600000); // 10 min

/* ============================================================
   MONTAR ANO
============================================================ */
function montarAno(){
  const anoDiv = document.getElementById("ano");
  anoDiv.innerHTML = "";

  const meses = [
    "Janeiro","Fevereiro","Março","Abril","Maio","Junho",
    "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
  ];

  meses.forEach((m,i)=>{
    const mesNum = i+1;
    const card = document.createElement("div");
    card.className = "card-mes";

    const lancMes = dadosLanc.filter(l=>{
      const d = new Date(l[1]);
      return d.getFullYear()==anoAtual && (d.getMonth()+1)==mesNum;
    });

    const rec = lancMes.filter(l=>l[2]==="Receita").reduce((t,x)=>t+Number(x[6]),0);
    const desp = lancMes.filter(l=>l[2]==="Despesa").reduce((t,x)=>t+Number(x[6]),0);
    const fech = rec - desp;

    card.innerHTML = `
      <h2>${m}</h2>
      <div class="resumo-mes">
        <span style="color:var(--green)">Receitas: ${maskMoney(rec)}</span>
        <span style="color:var(--orange)">Despesas: ${maskMoney(desp)}</span>
        <span style="color:var(--azul); font-weight:700;">Fechamento: ${maskMoney(fech)}</span>
      </div>
    `;

    card.onclick = ()=> abrirMes(mesNum, m);
    anoDiv.appendChild(card);
  });
}

/* ============================================================
   ABRIR MÊS
============================================================ */
function abrirMes(mes, nomeMes){
  const bg = document.getElementById("popup-mes-bg");
  const popup = document.getElementById("popupMes");

  popup.innerHTML = `
    <h2>${nomeMes} de ${anoAtual}</h2>
    <div class="grid-mes" id="gridMes"></div>
  `;

  gerarCalendarioMes(mes);

  bg.style.display = "flex";
}

function fecharMes(){
  document.getElementById("popup-mes-bg").style.display = "none";
}

/* ============================================================
   GERAR DIAS DO MÊS
============================================================ */
function gerarCalendarioMes(mes){
  const grid = document.getElementById("gridMes");
  grid.innerHTML = "";

  const primeiroDia = new Date(anoAtual, mes-1, 1);
  const ultimoDia = new Date(anoAtual, mes, 0);
  const inicioSemana = primeiroDia.getDay();
  const totalDias = ultimoDia.getDate();

  for(let i=0;i<inicioSemana;i++){
    const vazio = document.createElement("div");
    grid.appendChild(vazio);
  }

  for(let d=1; d<=totalDias; d++){
    const dataISO = `${anoAtual}-${String(mes).padStart(2,"0")}-${String(d).padStart(2,"0")}`;

    const lanc = dadosLanc.filter(x=>x[1].startsWith(dataISO));
    const rec = lanc.filter(x=>x[2]==="Receita").reduce((t,x)=>t+Number(x[6]),0);
    const desp = lanc.filter(x=>x[2]==="Despesa").reduce((t,x)=>t+Number(x[6]),0);
    const fech = rec - desp;

    const diaDiv = document.createElement("div");
    diaDiv.className = "dia";

    diaDiv.innerHTML = `
      <div class="dia-num">${d}</div>
      <div class="dia-rec">R: ${maskMoney(rec)}</div>
      <div class="dia-desp">D: ${maskMoney(desp)}</div>
      <div class="dia-fech">${maskMoney(fech)}</div>
    `;

    diaDiv.onclick = ()=> abrirDia(dataISO);
    grid.appendChild(diaDiv);
  }
}

/* ============================================================
   POPUP DO DIA
============================================================ */
function abrirDia(dataISO){

  document.getElementById("popup-dia-bg").style.display="flex";

  const d = new Date(dataISO);
  const nomeMes = d.toLocaleString("pt-BR",{month:"long"});
  tituloDia.innerText = `${d.getDate()} de ${nomeMes} de ${d.getFullYear()}`;

  const lanc = dadosLanc.filter(x=>x[1].startsWith(dataISO));

  listaDia.innerHTML = "";

  if(lanc.length==0){
    listaDia.innerHTML = `<p style='text-align:center;color:#666;'>Nenhum lançamento.</p>`;
  }

  lanc.forEach(l=>{
    const linha = document.createElement("div");
    linha.className = "linha "+(l[2]==="Receita" ? "receita" : "despesa");

    linha.innerHTML = `
      ${getStatusIcon(l[1])}
      <strong>${l[2]}</strong><br>
      Categoria: ${l[3]}<br>
      Sub: ${l[4]}<br>
      Desc: ${l[5]}<br>
      Valor: ${maskMoney(l[6])}<br><br>

      <button class="btn" onclick="editarLanc('${l[0]}','${dataISO}')">Editar</button>
      <button class="btn" style="background:var(--red)" onclick="excluirLanc('${l[0]}','${dataISO}')">Excluir</button>
    `;
    listaDia.appendChild(linha);
  });

  localStorage.setItem("diaAtual", dataISO);
}

function fecharDia(){
  document.getElementById("popup-dia-bg").style.display="none";
}

/* ============================================================
   CRUD DIRETO DO DIA
============================================================ */
function novoLancamentoDia(){
  const dia = localStorage.getItem("diaAtual");
  if(!dia) return alert("Erro.");

  const data = dia;
  const tipo = prompt("Tipo (Receita/Despesa):");
  const categoria = prompt("Categoria:");
  const sub = prompt("Subcategoria:");
  const desc = prompt("Descrição:");
  const valor = prompt("Valor (ex: 129.90):");

  if(!tipo||!categoria||!sub||!desc||!valor) return;

  fetch(`${API}?action=createLancamento&data=${data}&tipo=${tipo}&categoria=${categoria}&subcategoria=${sub}&descricao=${desc}&valor=${valor}`)
    .then(r=>r.json())
    .then(j=>{
      atualizarSegundoPlano();
      abrirDia(data);
    });
}

function editarLanc(id,data){
  const l = dadosLanc.find(x=>x[0]==id);

  const novoData = prompt("Data:", l[1]);
  const tipo = prompt("Tipo:", l[2]);
  const categoria = prompt("Categoria:", l[3]);
  const sub = prompt("Subcategoria:", l[4]);
  const desc = prompt("Descrição:", l[5]);
  const valor = prompt("Valor:", l[6]);

  const campos = JSON.stringify({
    data:novoData,tipo,categoria,subcategoria:sub,descricao:desc,valor
  });

  fetch(`${API}?action=editLancamento&id=${id}&campos=${encodeURIComponent(campos)}`)
  .then(r=>r.json())
  .then(j=>{
    atualizarSegundoPlano();
    abrirDia(novoData);
  });
}

function excluirLanc(id,dia){
  if(!confirm("Excluir?")) return;
  fetch(`${API}?action=deleteLancamento&id=${id}`)
  .then(()=>{ atualizarSegundoPlano(); abrirDia(dia); });
}

/* ============================================================
   START
============================================================ */
async function iniciar(){
  carregarLocal();
  montarAno();
  atualizarSegundoPlano();
}

iniciar();
</script>

</body>
</html>
