<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Lançamentos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ================================
   PALETA + VISUAL PREMIUM
================================ */
:root{
  --azul:#1F4E78;
  --azul-claro:#265a92;
  --bg:#f4f6f9;
  --green:#2ecc71;
  --orange:#ff9f43;
  --red:#e74c3c;
  --shadow:0 6px 22px rgba(0,0,0,0.12);
  --radius:16px;
}

/* BASE */
body{
  margin:0;
  padding:22px;
  background:var(--bg);
  font-family:Arial, sans-serif;
}

h2{
  margin-bottom:18px;
  color:var(--azul);
  font-size:32px;
  font-weight:bold;
}

/* ================================
   CARD DOS MESES (MODELO B)
================================ */
.cardMes{
  background:var(--azul);
  color:white;
  padding:14px 20px;
  margin-bottom:16px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  transition:.2s;
}

.cardMes:hover{
  background:var(--azul-claro);
  transform:scale(1.01);
}

.cardInfo{
  font-size:15px;
  opacity:.9;
}

.cardSaldoPositivo{ color:#4ade80; font-weight:bold; }
.cardSaldoNegativo{ color:#ff5757; font-weight:bold; }

/* ================================
   MODAL
================================ */
#modal-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  backdrop-filter:blur(3px);
  z-index:2000;
}

.modal{
  width:92%;
  max-width:900px;
  max-height:90%;
  overflow:auto;
  background:white;
  padding:25px;
  border-radius:20px;
  box-shadow:0 12px 35px rgba(0,0,0,0.25);
  animation:pop .25s ease;
}

@keyframes pop{
  from{ transform:scale(.85); opacity:0; }
  to{ transform:scale(1); opacity:1; }
}

.closeBtn{
  float:right;
  font-size:20px;
  cursor:pointer;
  color:#444;
}

/* ================================
   TABELA DO MODAL
================================ */
.table-custom{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}

.table-custom th{
  background:var(--azul);
  color:white;
  padding:12px;
  text-align:left;
}

.table-custom td{
  padding:10px;
  border-bottom:1px solid #ddd;
  font-size:14px;
}

.receita-row td{
  background:#e8f8ef;
  color:#15733e;
  font-weight:bold;
}

.despesa-row td{
  background:#fff2e6;
  color:#b05a14;
  font-weight:bold;
}

/* BOTÃO NOVO */
.btn{
  padding:12px 18px;
  border:none;
  border-radius:10px;
  color:white;
  cursor:pointer;
}
.btn-green{ background:var(--green); }

/* STATUS */
.statusIcon{
  font-size:18px;
}
.passado{ color:#2ecc71; }
.futuro{ color:#e74c3c; }

/* LOADING */
#loading{
  position:fixed;
  bottom:20px;
  left:20px;
  background:var(--azul);
  padding:12px 20px;
  border-radius:10px;
  color:white;
  display:none;
  animation:pulse 1.2s infinite;
  z-index:9999;
}
@keyframes pulse{
  0%{opacity:.4;}
  50%{opacity:1;}
  100%{opacity:.4;}
}

</style>
</head>

<body>

<div id="loading">Carregando...</div>

<h2>Lançamentos</h2>

<div id="cards"></div>

<!-- ==========================
       MODAL
========================== -->
<div id="modal-bg">
  <div class="modal">

    <span class="closeBtn" onclick="fecharModal()">✖</span>

    <h3 id="tituloMes"></h3>

    <button class="btn btn-green" onclick="novoLanc()">+ Novo Lançamento</button>

    <div id="modalConteudo"></div>

  </div>
</div>

<script>
/* ===============================
   CONFIG
=============================== */
const API = "https://script.google.com/macros/s/AKfycby8xeHkE0EwpMaVPOL6ggjgGasnMVa3piNIr6lCH8MdD7OZEsDA3-b5EjisScjfNLJGMw/exec";
const LS_KEY = "dv_financeiro_cache";

/* FUNÇÕES DE FORMATAÇÃO */
function maskMoney(v){
  return "R$ " + Number(v)
    .toFixed(2)
    .replace(".",",")
    .replace(/\B(?=(\d{3})+(?!\d))/g,".");
}

function formatarData(iso){
  const d = new Date(iso);
  return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
}

const hoje = new Date();
function getStatusIcon(dataISO){
  const d = new Date(dataISO);
  if(d < hoje) return `<span class="statusIcon passado">✔</span>`;
  if(d > hoje) return `<span class="statusIcon futuro">✖</span>`;
  return "";
}

/* ===============================
   RENDERIZA CARDS (MODELO B)
=============================== */
function renderizarCards(dados){
  const cards = document.getElementById("cards");
  cards.innerHTML = "";

  const grupos = {};

  dados.forEach(l=>{
    const data = new Date(l[1]);
    const mes = data.toLocaleString("pt-BR",{month:"long"})+" / "+data.getFullYear();

    if(!grupos[mes]) grupos[mes] = {lista:[], receita:0, despesa:0};
    grupos[mes].lista.push(l);

    if(l[2]==="Receita") grupos[mes].receita += Number(l[6]);
    else grupos[mes].despesa += Number(l[6]);
  });

  const meses = Object.keys(grupos).sort().reverse();

  meses.forEach(mes=>{
    const g = grupos[mes];
    const saldo = g.receita - g.despesa;

    const card = document.createElement("div");
    card.className = "cardMes";
    card.onclick = ()=>abrirMes(mes, g.lista);

    card.innerHTML = `
      <div style="font-size:20px; font-weight:bold;">${mes}</div>

      <div class="cardInfo">
        Receita: ${maskMoney(g.receita)} —
        Despesa: ${maskMoney(g.despesa)} —
        Saldo: <span class="${saldo>=0?'cardSaldoPositivo':'cardSaldoNegativo'}">
          ${maskMoney(saldo)}
        </span>
      </div>
    `;

    cards.appendChild(card);
  });
}

/* ===============================
   ABRIR POPUP DO MÊS
=============================== */
function abrirMes(mes, lista){
  document.getElementById("modal-bg").style.display="flex";
  document.getElementById("tituloMes").innerText = mes;

  lista.sort((a,b)=>new Date(a[1]) - new Date(b[1]));

  let html = `
    <table class="table-custom">
      <thead>
        <tr>
          <th>Status</th><th>Data</th><th>Tipo</th>
          <th>Categoria</th><th>Subcategoria</th>
          <th>Descrição</th><th>Valor</th><th></th>
        </tr>
      </thead>
      <tbody>
  `;

  lista.forEach(l=>{
    const cls = l[2]==="Receita" ? "receita-row" : "despesa-row";

    html += `
      <tr class="${cls}">
        <td>${getStatusIcon(l[1])}</td>
        <td>${formatarData(l[1])}</td>
        <td>${l[2]}</td>
        <td>${l[3]}</td>
        <td>${l[4]}</td>
        <td>${l[5]}</td>
        <td>${maskMoney(l[6])}</td>
        <td>
          <button onclick="editar('${l[0]}')">Editar</button>
          <button onclick="excluir('${l[0]}')">Excluir</button>
        </td>
      </tr>
    `;
  });

  html += "</tbody></table>";

  document.getElementById("modalConteudo").innerHTML = html;
}

function fecharModal(){
  document.getElementById("modal-bg").style.display="none";
}

/* ===============================
   LOCAL STORAGE + SYNC
=============================== */
async function syncBackground(){
  try{
    const r = await fetch(API+"?action=listLancamentos");
    const dados = await r.json();
    localStorage.setItem(LS_KEY, JSON.stringify(dados));
    renderizarCards(dados);
  }catch(e){}
}

setInterval(syncBackground, 10*60*1000);

/* ===============================
   LISTAR
=============================== */
async function listar(){
  let cache = localStorage.getItem(LS_KEY);

  if(cache){
    const dados = JSON.parse(cache);
    renderizarCards(dados);
    syncBackground();
    return;
  }

  document.getElementById("loading").style.display="flex";

  const r = await fetch(API+"?action=listLancamentos");
  const dados = await r.json();

  localStorage.setItem(LS_KEY, JSON.stringify(dados));
  renderizarCards(dados);

  document.getElementById("loading").style.display="none";
}

listar();

</script>

</body>
</html>
