<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Financeiro • Calendário Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ================================
   PALETA PREMIUM – AZUL + DOURADO
================================ */
:root{
  --azul:#0b1e39;
  --azul-escuro:#091627;
  --dourado:#c9a86c;
  --dourado-claro:#e2c78c;

  --green:#2ecc71;
  --orange:#ff9f43;
  --red:#e74c3c;

  --bg:#f4f6f9;
  --card:#ffffff;
  --shadow:0 8px 26px rgba(0,0,0,0.15);
  --radius:18px;
}

/* BASE */
body{
  margin:0;
  padding:20px;
  background:var(--bg);
  font-family:Arial, sans-serif;
  color:#222;
}

h1{
  color:var(--azul);
  text-align:center;
  font-size:36px;
  margin-bottom:25px;
  font-weight:800;
}

/* GRID ANUAL */
#ano{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap:25px;
  margin-top:20px;
}

/* CARD DO MÊS */
.card-mes{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px 20px;
  cursor:pointer;
  transition:.2s;
  border:2px solid var(--azul);
}
.card-mes:hover{
  transform:scale(1.02);
}

/* TÍTULO DO MÊS */
.card-mes h2{
  margin:0;
  font-size:22px;
  color:var(--azul);
  font-weight:700;
}

/* RESUMO FINANCEIRO */
.resumo-mes{
  margin-top:12px;
  font-size:15px;
  line-height:1.55;
}
.resumo-mes span{
  display:block;
  margin-top:4px;
}

/* POPUP MÊS */
#popup-mes-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  backdrop-filter:blur(3px);
}

.popup-mes{
  width:750px;
  max-height:90vh;
  overflow-y:auto;
  background:white;
  padding:25px;
  border-radius:22px;
  box-shadow:0 14px 40px rgba(0,0,0,0.35);
  animation:pop .25s ease;
}

@keyframes pop{
  from{transform:scale(.85); opacity:.3;}
  to{transform:scale(1); opacity:1;}
}

.popup-mes h2{
  color:var(--azul);
  text-align:center;
  margin-top:0;
  font-size:28px;
  font-weight:800;
}

.grid-dias{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;
  margin-top:20px;
}

/* DIA NO POPUP DO MÊS */
.card-dia{
  background:white;
  border-radius:14px;
  padding:10px;
  min-height:95px;
  box-shadow:0 4px 16px rgba(0,0,0,0.07);
  cursor:pointer;
  border:1px solid #eee;
  transition:.2s;
}
.card-dia:hover{
  transform:scale(1.05);
  border-color:var(--dourado);
}

.card-dia-num{
  font-weight:700;
  color:var(--azul);
  font-size:17px;
}

.card-dia-rec{
  font-size:13px;
  color:var(--green);
}
.card-dia-desp{
  font-size:13px;
  color:var(--orange);
}
.card-dia-fech{
  margin-top:4px;
  font-size:13px;
  font-weight:700;
  color:var(--azul);
}

/* POPUP DO DIA */
#popup-dia-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99999;
  backdrop-filter:blur(3px);
}

.popup-dia{
  width:520px;
  max-height:90vh;
  overflow-y:auto;
  background:white;
  padding:22px;
  border-radius:20px;
  box-shadow:0 14px 40px rgba(0,0,0,0.35);
  animation:pop .25s ease;
}

.popup-dia h2{
  margin:0 0 15px 0;
  text-align:center;
  font-size:24px;
  color:var(--azul);
}

/* LINHAS DO DIA */
.linha{
  background:#fdfdfd;
  border-radius:12px;
  padding:12px 14px;
  margin-bottom:10px;
  border-left:6px solid var(--azul);
  box-shadow:0 4px 16px rgba(0,0,0,0.08);
}

.linha.receita{ border-color:var(--green); }
.linha.despesa{ border-color:var(--orange); }

.linha strong{
  font-size:15px;
}

/* BOTÕES */
.btn{
  padding:12px;
  border:none;
  border-radius:12px;
  font-size:15px;
  color:white;
  cursor:pointer;
  margin-top:14px;
  width:100%;
}
.btn-gold{ background:var(--dourado); color:var(--azul-escuro); }
.btn-blue{ background:var(--azul); }
.btn-red{ background:var(--red); }
.btn-close{ background:#777; }

</style>
</head>
<body>

<h1>Calendário Financeiro • 2025</h1>

<div id="ano"></div>
<!-- POPUP DO MÊS -->
<div id="popup-mes-bg">
  <div class="popup-mes" id="popupMes">

    <h2 id="tituloMes"></h2>

    <div style="text-align:center; margin-bottom:15px;">
      <button class="btn-gold" onclick="novoLancamentoMes()">+ Novo Lançamento no Mês</button>
      <button class="btn-close" onclick="fecharPopupMes()">Fechar</button>
    </div>

    <div id="gridDias" class="grid-dias"></div>

    <h3 style="text-align:center; margin-top:25px; color:var(--azul); font-size:20px;">
      Resumo do Mês
    </h3>

    <div id="resumoMesPopup"
      style="background:#fff; padding:18px; border-radius:16px; box-shadow:var(--shadow); margin-top:10px;">
    </div>

  </div>
</div>

<!-- POPUP DIA -->
<div id="popup-dia-bg">
  <div class="popup-dia" id="popupDia">

    <h2 id="tituloDia"></h2>

    <div style="text-align:center; margin-bottom:15px;">
      <button class="btn-gold" onclick="novoLancamentoDia()">+ Novo Lançamento no Dia</button>
    </div>

    <div id="listaDia"></div>

    <button class="btn-close" onclick="fecharPopupDia()">Fechar</button>

  </div>
</div>

<script>
/* =====================================================
      API + STORAGE + VARIÁVEIS
===================================================== */
const API = "https://script.google.com/macros/s/AKfycby8xeHkE0EwpMaVPOL6ggjgGasnMVa3piNIr6lCH8MdD7OZEsDA3-b5EjisScjfNLJGMw/exec";
let dadosLanc = [];
let anoAtual = 2025;

/* ================================
      MÁSCARA DE VALOR
================================ */
function maskMoney(v){
  return "R$ " + Number(v).toFixed(2)
    .replace(".",",")
    .replace(/\B(?=(\d{3})+(?!\d))/g,".");
}

/* ================================
      STORAGE LOCAL
================================ */
function carregarLocal(){
  const l = localStorage.getItem("lancamentos");
  if(l){ dadosLanc = JSON.parse(l); }
}
function salvarLocal(){
  localStorage.setItem("lancamentos", JSON.stringify(dadosLanc));
}

/* Atualização automática em segundo plano */
async function atualizarSegundoPlano(){
  try{
    const r = await fetch(API+"?action=listLancamentos");
    const dados = await r.json();
    dadosLanc = dados;
    salvarLocal();
    montarAno();
  }catch(e){
    console.log("Erro atualização BG:", e);
  }
}
setInterval(atualizarSegundoPlano, 600000); /* 10 min */

/* =====================================================
      GERAR ANO COMPLETO
===================================================== */
function montarAno(){
  const anoDiv = document.getElementById("ano");
  anoDiv.innerHTML = "";

  const meses = [
    "Janeiro","Fevereiro","Março","Abril","Maio","Junho",
    "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
  ];

  meses.forEach((m,i)=>{
    const card = document.createElement("div");
    card.className="card-mes";

    const mesNum = i+1;

    const lancMes = dadosLanc.filter(l=>{
      const d = new Date(l[1]);
      return d.getFullYear()==anoAtual && (d.getMonth()+1)==mesNum;
    });

    const rec = lancMes.filter(l=>l[2]==="Receita").reduce((t,x)=>t+Number(x[6]),0);
    const desp = lancMes.filter(l=>l[2]==="Despesa").reduce((t,x)=>t+Number(x[6]),0);
    const fech = rec - desp;

    card.innerHTML = `
      <h2>${m}</h2>
      <div class="resumo-mes">
        <span style="color:var(--green)">Receitas: ${maskMoney(rec)}</span>
        <span style="color:var(--orange)">Despesas: ${maskMoney(desp)}</span>
        <span style="color:var(--azul); font-weight:700;">Fechamento: ${maskMoney(fech)}</span>
      </div>
    `;

    card.onclick = ()=> abrirMes(mesNum, m);
    anoDiv.appendChild(card);
  });
}
/* =====================================================
      ABRIR POPUP DO MÊS
===================================================== */
function abrirMes(mesNum, nomeMes){
  const bg = document.getElementById("popup-mes-bg");
  const titulo = document.getElementById("tituloMes");
  const gridDias = document.getElementById("gridDias");
  const resumoDiv = document.getElementById("resumoMesPopup");

  bg.style.display = "flex";
  titulo.innerText = `${nomeMes} • ${anoAtual}`;

  gridDias.innerHTML = "";
  resumoDiv.innerHTML = "";

  gerarCalendarioMes(mesNum, gridDias);
  gerarResumoMes(mesNum, resumoDiv);

  localStorage.setItem("mesAtual", mesNum);
}

/* Fechar Mês */
function fecharPopupMes(){
  document.getElementById("popup-mes-bg").style.display="none";
}

/* =====================================================
      GERAR CALENDÁRIO DO MÊS (DENTRO DO POPUP)
===================================================== */
function gerarCalendarioMes(mesNum, grid){
  grid.innerHTML = "";
  grid.className = "grid-mes-popup";

  const diasSemana = ["D","S","T","Q","Q","S","S"];
  diasSemana.forEach(d=>{
    const hd = document.createElement("div");
    hd.className="header-dia";
    hd.innerText = d;
    grid.appendChild(hd);
  });

  const primeiro = new Date(anoAtual, mesNum-1, 1);
  const ultimo = new Date(anoAtual, mesNum, 0);

  const comeco = primeiro.getDay();
  const diasMes = ultimo.getDate();

  // vazios antes do dia 1
  for(let i=0;i<comeco;i++){
    const vazio = document.createElement("div");
    vazio.className="dia vazio";
    grid.appendChild(vazio);
  }

  // dias do mês
  for(let d=1; d<=diasMes; d++){
    const dataISO = `${anoAtual}-${String(mesNum).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dia = document.createElement("div");
    dia.className = "dia dia-popup";

    const lanc = dadosLanc.filter(x=>x[1].startsWith(dataISO));
    const rec = lanc.filter(x=>x[2]=="Receita").reduce((t,x)=>t+Number(x[6]),0);
    const desp = lanc.filter(x=>x[2]=="Despesa").reduce((t,x)=>t+Number(x[6]),0);

    const fech = rec - desp;

    dia.innerHTML = `
      <div class="dia-num-popup">${d}</div>
      <div class="dia-summary">
        <span class="r">R: ${maskMoney(rec)}</span>
        <span class="d">D: ${maskMoney(desp)}</span>
        <span class="f">${maskMoney(fech)}</span>
      </div>
    `;

    dia.onclick = ()=> abrirDia(dataISO);

    grid.appendChild(dia);
  }
}

/* =====================================================
      GERAR RESUMO DO MÊS (POPUP)
===================================================== */
function gerarResumoMes(mesNum, container){
  const lanc = dadosLanc.filter(l=>{
    const d = new Date(l[1]);
    return d.getFullYear()==anoAtual && (d.getMonth()+1)==mesNum;
  });

  const rec = lanc.filter(l=>l[2]=="Receita").reduce((t,x)=>t+Number(x[6]),0);
  const desp = lanc.filter(l=>l[2]=="Despesa").reduce((t,x)=>t+Number(x[6]),0);
  const fech = rec - desp;

  container.innerHTML = `
    <p style="font-size:17px; color:var(--green)">Receitas: <b>${maskMoney(rec)}</b></p>
    <p style="font-size:17px; color:var(--orange)">Despesas: <b>${maskMoney(desp)}</b></p>
    <p style="font-size:18px; color:var(--azul); font-weight:700;">
      Fechamento: ${maskMoney(fech)}
    </p>

    <!-- Meta definida -->
    <p style="margin-top:12px; font-size:15px; color:#333;">
      Meta de gastos: <b>R$ 2.000,00</b>
    </p>

    <div style="height:14px; background:#ddd; border-radius:8px; overflow:hidden; margin-top:6px;">
      <div style="height:14px; background:${
        desp <= 2000 ? "var(--green)" : "var(--red)"
      }; width:${Math.min((desp/2000)*100,100)}%;"></div>
    </div>
  `;
}

/* =====================================================
      POPUP DO DIA
===================================================== */
function abrirDia(dataISO){
  const bg = document.getElementById("popup-dia-bg");
  const listaDia = document.getElementById("listaDia");
  const tituloDia = document.getElementById("tituloDia");

  bg.style.display="flex";

  const d = new Date(dataISO);
  const nomeMes = d.toLocaleString("pt-BR", {month:"long"});
  tituloDia.innerText = `${d.getDate()} de ${nomeMes} de ${d.getFullYear()}`;

  const lanc = dadosLanc.filter(x=>x[1].startsWith(dataISO));

  listaDia.innerHTML = "";

  if(lanc.length == 0){
    listaDia.innerHTML = `<p style="text-align:center;color:#777;">Nenhum lançamento.</p>`;
  }

  lanc.sort((a,b)=> Number(a[0]) - Number(b[0]));

  lanc.forEach(l=>{
    const linha = document.createElement("div");
    linha.className = `linha ${l[2]=="Receita" ? "receita":"despesa"}`;

    // status passado / futuro
    const hoje = new Date();
    const dataL = new Date(l[1]);
    let icone = "";
    if(dataL < hoje){
      icone = `<span style="color:var(--green); font-size:18px;">✔</span>`;
    } else if(dataL > hoje){
      icone = `<span style="color:var(--red); font-size:18px;">✖</span>`;
    }

    linha.innerHTML = `
      <strong>${icone} ${l[2]}</strong><br>
      Categoria: ${l[3]}<br>
      Sub: ${l[4]}<br>
      Desc: ${l[5]}<br>
      Valor: ${maskMoney(l[6])}<br><br>

      <button class="btn" onclick="editarLanc('${l[0]}')">Editar</button>
      <button class="btn" style="background:var(--red)" onclick="excluirLanc('${l[0]}','${dataISO}')">Excluir</button>
    `;

    listaDia.appendChild(linha);
  });

  localStorage.setItem("diaAtual", dataISO);
}

function fecharPopupDia(){
  document.getElementById("popup-dia-bg").style.display="none";
}
/* =====================================================
      NOVO LANÇAMENTO DIRETO DO MÊS
===================================================== */
function novoLancamentoMes(){
  const mes = localStorage.getItem("mesAtual");
  if(!mes) return alert("Erro ao definir mês.");

  const dia = prompt("Dia do lançamento (1-31):");
  if(!dia) return;

  const data = `${anoAtual}-${String(mes).padStart(2,"0")}-${String(dia).padStart(2,"0")}`;
  const tipo = prompt("Tipo (Receita / Despesa):");
  const categoria = prompt("Categoria:");
  const sub = prompt("Subcategoria:");
  const desc = prompt("Descrição:");
  const valor = prompt("Valor (1000.00):");

  if(!data || !tipo || !categoria || !sub || !desc || !valor){
    alert("Preencha todos os campos!");
    return;
  }

  fetch(`${API}?action=createLancamento&data=${data}&tipo=${tipo}&categoria=${categoria}&subcategoria=${sub}&descricao=${desc}&valor=${valor}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status==="ok"){
        atualizarSegundoPlano();
        abrirMes(Number(mes));
      } else {
        alert("Erro ao salvar.");
      }
    });
}

/* =====================================================
      NOVO LANÇAMENTO DIRETO DO DIA
===================================================== */
function novoLancamentoDia(){
  const data = localStorage.getItem("diaAtual");
  if(!data) return;

  const tipo = prompt("Tipo (Receita / Despesa):");
  const categoria = prompt("Categoria:");
  const sub = prompt("Subcategoria:");
  const desc = prompt("Descrição:");
  const valor = prompt("Valor (1000.00):");

  if(!tipo || !categoria || !sub || !desc || !valor){
    alert("Preencha todos os campos.");
    return;
  }

  fetch(`${API}?action=createLancamento&data=${data}&tipo=${tipo}&categoria=${categoria}&subcategoria=${sub}&descricao=${desc}&valor=${valor}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status==="ok"){
        atualizarSegundoPlano();
        abrirDia(data);
      } else {
        alert("Erro ao salvar.");
      }
    });
}

/* =====================================================
      EDITAR LANÇAMENTO
===================================================== */
function editarLanc(id){
  const l = dadosLanc.find(x=>x[0]==id);
  if(!l) return alert("Erro ao localizar lançamento.");

  const data = prompt("Data:", l[1]);
  const tipo = prompt("Tipo (Receita / Despesa):", l[2]);
  const categoria = prompt("Categoria:", l[3]);
  const sub = prompt("Subcategoria:", l[4]);
  const desc = prompt("Descrição:", l[5]);
  const valor = prompt("Valor:", l[6]);

  const campos = JSON.stringify({
    data, tipo, categoria,
    subcategoria: sub,
    descricao: desc,
    valor
  });

  fetch(`${API}?action=editLancamento&id=${id}&campos=${encodeURIComponent(campos)}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status==="ok"){
        atualizarSegundoPlano();
        abrirDia(data);
      } else {
        alert("Erro ao editar.");
      }
    });
}

/* =====================================================
      EXCLUIR LANÇAMENTO
===================================================== */
function excluirLanc(id, dia){
  if(!confirm("Excluir este lançamento?")) return;

  fetch(`${API}?action=deleteLancamento&id=${id}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status==="ok"){
        atualizarSegundoPlano();
        abrirDia(dia);
      } else {
        alert("Erro ao excluir.");
      }
    });
}

/* =====================================================
      INICIAR TELA
===================================================== */
function iniciar(){
  carregarLocal();
  montarAno();
  atualizarSegundoPlano();
}

iniciar();
</script>

</body>
</html>
