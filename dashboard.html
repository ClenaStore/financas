<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --azul:#1F4E78;
  --azul2:#2565a8;
  --bg:#eef3fa;
  --card:#ffffff;
  --radius:18px;
  --shadow:0 10px 45px rgba(0,0,0,0.12);
  --verde:#2ecc71;
  --vermelho:#e74c3c;
  --texto:#223;
}

/* GERAL */
body{
  margin:0;
  padding:30px;
  background:var(--bg);
  font-family:Arial;
}

h2{
  font-size:36px;
  margin-bottom:25px;
  color:var(--azul);
  letter-spacing:1px;
}

/* CARDS */
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(270px,1fr));
  gap:25px;
  margin-bottom:35px;
}

.card{
  background:white;
  padding:30px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  transition:.25s;
  position:relative;
  overflow:hidden;
}
.card:hover{
  transform:translateY(-5px);
}

.card h3{
  margin:0 0 12px 0;
  color:var(--azul2);
  font-size:18px;
}

.card .valor{
  font-size:32px;
  font-weight:bold;
}

/* GRÁFICO BOX */
.grafico-box{
  background:white;
  margin-top:35px;
  padding:30px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  animation:fade .5s ease-out;
}

@keyframes fade{
  from{ opacity:0; transform:translateY(15px); }
  to{ opacity:1; transform:translateY(0); }
}

/* LOADING */
#loading{
  position:fixed;
  bottom:20px;
  left:20px;
  background:#1F4E78;
  padding:12px 20px;
  border-radius:12px;
  color:white;
  font-size:16px;
  box-shadow:var(--shadow);
  display:none;
  z-index:999;
  animation:pulse 1s infinite;
}

@keyframes pulse{
  0%{opacity:.6}
  50%{opacity:1}
  100%{opacity:.6}
}
</style>
</head>

<body>

<div id="loading">Atualizando Dashboard...</div>

<h2>Dashboard Financeiro</h2>

<div class="cards">
  <div class="card">
    <h3>Receita Total</h3>
    <div id="receitaTotal" class="valor" style="color:var(--verde)">R$ 0,00</div>
  </div>
  <div class="card">
    <h3>Despesa Total</h3>
    <div id="despesaTotal" class="valor" style="color:var(--vermelho)">R$ 0,00</div>
  </div>
  <div class="card">
    <h3>Saldo Total</h3>
    <div id="saldoTotal" class="valor" style="color:var(--azul2)">R$ 0,00</div>
  </div>
</div>

<div class="grafico-box">
  <h3>Receita × Despesa (Últimos 12 meses)</h3>
  <canvas id="graficoLinha"></canvas>
</div>

<div class="grafico-box">
  <h3>Totais por Categoria</h3>
  <canvas id="graficoCategorias"></canvas>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyInCpy_Ln1XQhcnbsfPHRimjx0frnOQDRgAyPtraKw_scr7uXP631SUyQZpIlUSi7IMA/exec";

let grafLinha, grafCat;

function fmt(v){
  return Number(v).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

/* ======================
     CARREGAMENTO OCULTO
   ====================== */

async function preload(url){
  try{
    return await fetch(url).then(r=>r.json());
  }catch(e){
    return null;
  }
}

let cache = {
  dashboard:null,
  fluxo:null,
  lanc:null
};

/* TAREFA EM SEGUNDO PLANO — Pré-carrega tudo antes do usuário ver */
setTimeout(async ()=>{
  cache.dashboard = await preload(API+"?action=dashboard");
  cache.fluxo = await preload(API+"?action=fluxo");
  cache.lanc = await preload(API+"?action=listLancamentos");
}, 50);

/* ======================
     CARREGAR CARDS
   ====================== */

async function carregarTotais(){
  let dados = cache.dashboard || await preload(API+"?action=dashboard");

  let receita = dados.find(l=>l[0]==="receita_total")[1];
  let despesa = dados.find(l=>l[0]==="despesa_total")[1];
  let saldo = dados.find(l=>l[0]==="saldo_total")[1];

  receitaTotal.innerText = fmt(receita);
  despesaTotal.innerText = fmt(despesa);
  saldoTotal.innerText = fmt(saldo);
}

/* ======================
     GRÁFICO LINHA
   ====================== */

async function carregarGraficoLinha(){
  let dados = cache.fluxo || await preload(API+"?action=fluxo");

  let meses=[], receitas=[], despesas=[];
  dados.slice(1).forEach(l=>{
    meses.push(l[0]);
    receitas.push(l[1]);
    despesas.push(l[2]);
  });

  if(grafLinha) grafLinha.destroy();

  grafLinha = new Chart(graficoLinha,{
    type:"line",
    data:{
      labels:meses,
      datasets:[
        {
          label:"Receitas",
          data:receitas,
          borderColor:"#2ecc71",
          backgroundColor:"rgba(46,204,113,0.18)",
          fill:true,
          tension:0.35,
          borderWidth:3
        },
        {
          label:"Despesas",
          data:despesas,
          borderColor:"#e74c3c",
          backgroundColor:"rgba(231,76,60,0.18)",
          fill:true,
          tension:0.35,
          borderWidth:3
        }
      ]
    }
  });
}

/* ======================
    GRÁFICO CATEGORIAS
   ====================== */

async function carregarGraficoCategorias(){
  let lanc = cache.lanc || await preload(API+"?action=listLancamentos");

  let categorias={};
  lanc.forEach(l=>{
    let tipo=l[2], cat=l[3], val=Number(l[6]);
    if(!categorias[cat]) categorias[cat]=0;
    categorias[cat]+= tipo==="Despesa" ? -val : val;
  });

  let labels=Object.keys(categorias);
  let valores=Object.values(categorias);

  if(grafCat) grafCat.destroy();

  grafCat=new Chart(graficoCategorias,{
    type:"bar",
    data:{
      labels,
      datasets:[{
        label:"Valor",
        data:valores,
        borderRadius:8,
        backgroundColor: valores.map(v=> v>=0
          ? "rgba(46,204,113,.7)"
          : "rgba(231,76,60,.7)"
        )
      }]
    }
  });
}

/* ======================
      START
   ====================== */

async function iniciar(){
  loading(true);

  await carregarTotais();
  await carregarGraficoLinha();
  await carregarGraficoCategorias();

  setTimeout(()=>loading(false),400);
}

function loading(v){
  document.getElementById("loading").style.display = v ? "flex" : "none";
}

iniciar();
</script>

</body>
</html>
