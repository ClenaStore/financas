<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --azul:#1F4E78;
  --azul2:#2565a8;
  --bg:#eef3fa;
  --card:#ffffff;
  --radius:18px;
  --shadow:0 8px 28px rgba(0,0,0,0.12);
  --verde:#2ecc71;
  --vermelho:#e74c3c;
  --texto:#223;
}

/* GERAL */
body{
  margin:0;
  padding:25px;
  background:var(--bg);
  font-family:Arial;
}

h2{
  font-size:32px;
  margin-bottom:20px;
  color:var(--azul);
}

/* CARDS */
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:20px;
  margin-bottom:25px;
}

.card{
  background:white;
  padding:22px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

.card h3{
  margin:0 0 8px 0;
  font-size:17px;
  color:var(--azul2);
}

.valor{
  font-size:28px;
  font-weight:bold;
}

/* GRAFICOS */
.grafico-box{
  background:white;
  margin-top:20px;
  padding:22px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

canvas{
  max-height:260px !important;
}

/* LOADING */
#loading{
  position:fixed;
  bottom:20px;
  left:20px;
  background:#1F4E78;
  padding:12px 20px;
  border-radius:12px;
  color:white;
  font-size:14px;
  box-shadow:var(--shadow);
  display:none;
  z-index:999;
}
</style>
</head>

<body>

<div id="loading">Carregando...</div>

<h2>Dashboard Financeiro</h2>

<div class="cards">
  <div class="card">
    <h3>Receita Total</h3>
    <div id="receitaTotal" class="valor" style="color:var(--verde)">R$ 0,00</div>
  </div>

  <div class="card">
    <h3>Despesa Total</h3>
    <div id="despesaTotal" class="valor" style="color:var(--vermelho)">R$ 0,00</div>
  </div>

  <div class="card">
    <h3>Saldo Total</h3>
    <div id="saldoTotal" class="valor" style="color:var(--azul2)">R$ 0,00</div>
  </div>
</div>

<div class="grafico-box">
  <h3>Receita × Despesa (Últimos 12 meses)</h3>
  <canvas id="graficoLinha"></canvas>
</div>

<div class="grafico-box">
  <h3>Totais por Categoria</h3>
  <canvas id="graficoCategorias"></canvas>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyInCpy_Ln1XQhcnbsfPHRimjx0frnOQDRgAyPtraKw_scr7uXP631SUyQZpIlUSi7IMA/exec";

let grafLinha, grafCat;
let cache = { dashboard:null, fluxo:null, lanc:null };

function fmt(v){
  return Number(v).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

function loading(v){
  document.getElementById("loading").style.display = v ? "block" : "none";
}

/* PRÉ CARREGAMENTO */
async function preload(){
  try{
    cache.dashboard = await fetch(API+"?action=dashboard").then(r=>r.json());
    cache.fluxo     = await fetch(API+"?action=fluxo").then(r=>r.json());
    cache.lanc      = await fetch(API+"?action=listLancamentos").then(r=>r.json());
  }catch(e){
    console.log("Erro no preload:", e);
  }
}

/* CARDS */
function carregarTotais(){
  if(!cache.dashboard) return;

  let receita = cache.dashboard.find(l=>l[0]=="receita_total")[1];
  let despesa = cache.dashboard.find(l=>l[0]=="despesa_total")[1];
  let saldo   = cache.dashboard.find(l=>l[0]=="saldo_total")[1];

  receitaTotal.innerText = fmt(receita);
  despesaTotal.innerText = fmt(despesa);
  saldoTotal.innerText   = fmt(saldo);
}

/* GRÁFICO LINHA */
function carregarGraficoLinha(){
  if(!cache.fluxo) return;

  let dados = cache.fluxo.slice(1); // IGNORA CABEÇALHO

  // Ordenar por data (garante ordem correta)
  dados.sort((a,b)=>{
    let da = new Date("01/" + a[0]);
    let db = new Date("01/" + b[0]);
    return da - db;
  });

  // PEGAR APENAS OS ÚLTIMOS 12
  dados = dados.slice(-12);

  let meses = dados.map(l=>l[0]);
  let receitas = dados.map(l=>l[1]);
  let despesas = dados.map(l=>l[2]);

  if(grafLinha) grafLinha.destroy();

  grafLinha = new Chart(graficoLinha,{
    type:"line",
    data:{
      labels:meses,
      datasets:[
        {
          label:"Receitas",
          data:receitas,
          borderColor:"#2ecc71",
          backgroundColor:"rgba(46,204,113,0.15)",
          fill:true,
          tension:0.3
        },
        {
          label:"Despesas",
          data:despesas,
          borderColor:"#e74c3c",
          backgroundColor:"rgba(231,76,60,0.15)",
          fill:true,
          tension:0.3
        }
      ]
    },
    options:{ animation:{ duration:300 } }
  });
}

/* GRÁFICO CATEGORIAS */
function carregarGraficoCategorias(){
  if(!cache.lanc) return;

  let categorias={};

  cache.lanc.forEach(l=>{
    let tipo=l[2], cat=l[3], val=Number(l[6]);
    categorias[cat] = (categorias[cat]||0) + (tipo==="Despesa" ? -val : val);
  });

  let labels = Object.keys(categorias);
  let valores = Object.values(categorias);

  if(grafCat) grafCat.destroy();

  grafCat = new Chart(graficoCategorias,{
    type:"bar",
    data:{
      labels,
      datasets:[{
        label:"Valor",
        data:valores,
        borderRadius:6,
        backgroundColor: valores.map(v=> v>=0 ? "rgba(46,204,113,0.7)" : "rgba(231,76,60,0.7)")
      }]
    },
    options:{ animation:{ duration:300 } }
  });
}

/* INÍCIO */
async function iniciar(){
  loading(true);
  await preload();
  carregarTotais();
  carregarGraficoLinha();
  carregarGraficoCategorias();
  loading(false);
}

iniciar();
</script>

</body>
</html>
