<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard Financeiro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --azul:#1F4E78;
  --verde:#2ecc71;
  --vermelho:#e74c3c;
  --bg:#eef3fa;
  --card:#ffffff;
  --radius:18px;
  --shadow:0 8px 28px rgba(0,0,0,0.12);
}

body{
  margin:0;
  padding:25px;
  background:var(--bg);
  font-family:Arial, sans-serif;
}

h2{
  color:var(--azul);
  font-size:32px;
  margin-bottom:20px;
}

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:20px;
}

.card{
  background:white;
  padding:22px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

.card h3{
  margin:0 0 8px 0;
  color:#2565a8;
  font-size:17px;
}

.valor{
  font-size:28px;
  font-weight:bold;
}

.box{
  background:white;
  padding:22px;
  margin-top:25px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

canvas{ max-height:260px !important; }

.lista{
  margin-top:15px;
  font-size:16px;
}

.lista li{
  background:#f8fbff;
  padding:8px 12px;
  margin-bottom:6px;
  border-radius:10px;
  border-left:5px solid var(--azul);
}

#loading{
  position:fixed;
  bottom:20px;
  left:20px;
  background:#1F4E78;
  padding:12px 22px;
  border-radius:14px;
  color:white;
  font-size:16px;
  display:none;
  animation:pulse 1.2s infinite;
  z-index:999;
}
@keyframes pulse{
  0%{opacity:.5; transform:scale(.95);}
  50%{opacity:1; transform:scale(1);}
  100%{opacity:.5; transform:scale(.95);}
}
</style>
</head>

<body>

<div id="loading">Carregando…</div>

<h2>Dashboard Financeiro</h2>

<!-- CARDS -->
<div class="cards">
  <div class="card">
    <h3>Receita Total</h3>
    <div id="receitaTotal" class="valor" style="color:var(--verde)">R$ 0,00</div>
  </div>

  <div class="card">
    <h3>Despesa Total</h3>
    <div id="despesaTotal" class="valor" style="color:var(--vermelho)">R$ 0,00</div>
  </div>

  <div class="card">
    <h3>Saldo Total</h3>
    <div id="saldoTotal" class="valor">R$ 0,00</div>
  </div>
</div>

<!-- GRAFICO LINHA -->
<div class="box">
  <h3>Receita × Despesa (12 meses)</h3>
  <canvas id="grafLinha"></canvas>
</div>

<!-- GRAFICO POR CATEGORIA -->
<div class="box">
  <h3>Gastos por Categoria</h3>
  <canvas id="grafCategorias"></canvas>
</div>

<!-- CATEGORIAS COM AUMENTO -->
<div class="box">
  <h3>Categorias com Aumento em Relação ao Mês Anterior</h3>
  <ul id="listaAumento" class="lista"></ul>
</div>

<!-- RECORRENCIAS -->
<div class="box">
  <h3>Despesas Recorrentes (3+ meses seguidos)</h3>
  <ul id="listaRecorrencia" class="lista"></ul>
</div>

<script>

const API = "https://script.google.com/macros/s/AKfycby8xeHkE0EwpMaVPOL6ggjgGasnMVa3piNIr6lCH8MdD7OZEsDA3-b5EjisScjfNLJGMw/exec";

let lanc = []; // lançamentos

let graf1, graf2;

function fmt(v){
  return Number(v).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

function load(v){
  document.getElementById("loading").style.display = v ? "flex" : "none";
}

/* ================================
   CARREGAR LANÇAMENTOS
================================*/
async function carregarLanc(){
  load(true);
  let r = await fetch(API+"?action=listLancamentos");
  lanc = await r.json();
  load(false);
}

/* ================================
   CARDS
================================*/
function montarCards(){
  let receita = 0, despesa = 0;

  lanc.forEach(l=>{
    if(l[2] === "Receita") receita += Number(l[6]);
    else despesa += Number(l[6]);
  });

  receitaTotal.innerText = fmt(receita);
  despesaTotal.innerText = fmt(despesa);
  saldoTotal.innerText   = fmt(receita - despesa);
}

/* ================================
   GRÁFICO LINHA
================================*/
function graficoLinha(){
  let meses = {};
  lanc.forEach(l=>{
    let d = new Date(l[1]);
    let m = String(d.getMonth()+1).padStart(2,"0") + "/" + d.getFullYear();
    if(!meses[m]) meses[m]= {r:0,d:0};
    if(l[2]==="Receita") meses[m].r += Number(l[6]);
    else meses[m].d += Number(l[6]);
  });

  let ordem = Object.keys(meses).sort((a,b)=>{
    let pa = a.split("/");
    let pb = b.split("/");
    return new Date(pa[1], pa[0]-1) - new Date(pb[1], pb[0]-1);
  }).slice(-12);

  let labels = ordem;
  let r = ordem.map(m=>meses[m].r);
  let d = ordem.map(m=>meses[m].d);

  if(graf1) graf1.destroy();

  graf1 = new Chart(grafLinha,{
    type:"line",
    data:{
      labels,
      datasets:[
        { label:"Receitas", data:r, borderColor:"#2ecc71", tension:0.3 },
        { label:"Despesas", data:d, borderColor:"#e74c3c", tension:0.3 }
      ]
    }
  });
}

/* ================================
   GRAFICO POR CATEGORIA
================================*/
function graficoCategorias(){
  let cat = {};
  lanc.forEach(l=>{
    if(l[2]==="Despesa"){
      let c = l[3];
      cat[c] = (cat[c]||0) + Number(l[6]);
    }
  });

  let labels = Object.keys(cat);
  let valores = Object.values(cat);

  if(graf2) graf2.destroy();

  graf2 = new Chart(grafCategorias,{
    type:"bar",
    data:{
      labels,
      datasets:[{
        label:"Gastos",
        data:valores,
        backgroundColor:"rgba(231,76,60,0.7)"
      }]
    }
  });
}

/* ================================
   CATEGORIAS COM AUMENTO
================================*/
function categoriasAumento(){
  let meses = {};

  lanc.forEach(l=>{
    if(l[2]==="Despesa"){
      let d = new Date(l[1]);
      let m = String(d.getMonth()+1).padStart(2,"0")+"/"+d.getFullYear();
      let c = l[3];

      if(!meses[m]) meses[m]={};
      meses[m][c] = (meses[m][c]||0) + Number(l[6]);
    }
  });

  let ordem = Object.keys(meses).sort((a,b)=>{
    let pa=a.split("/"), pb=b.split("/");
    return new Date(pa[1],pa[0]-1)-new Date(pb[1],pb[0]-1);
  });

  let html = "";

  for(let i=1;i<ordem.length;i++){
    let atual = meses[ordem[i]];
    let anterior = meses[ordem[i-1]];

    for(let c in atual){
      let valA = atual[c];
      let valB = anterior[c] || 0;

      if(valA > valB && valB > 0){
        html += `<li><b>${c}</b> aumentou de ${fmt(valB)} para ${fmt(valA)} (${ordem[i]})</li>`;
      }
    }
  }

  listaAumento.innerHTML = html || "<li>Nenhum aumento identificado</li>";
}

/* ================================
   RECORRÊNCIAS (3+ meses seguidos)
================================*/
function recorrencias(){
  let meses = {};

  lanc.forEach(l=>{
    if(l[2]==="Despesa"){
      let d=new Date(l[1]);
      let m=String(d.getMonth()+1).padStart(2,"0")+"/"+d.getFullYear();
      let c=l[3];

      if(!meses[c]) meses[c]={};
      meses[c][m]=true;
    }
  });

  let html="";

  for(let c in meses){
    let qt = Object.keys(meses[c]).length;
    if(qt>=3){
      html += `<li><b>${c}</b> apareceu em ${qt} meses diferentes</li>`;
    }
  }

  listaRecorrencia.innerHTML = html || "<li>Nenhuma recorrência encontrada</li>";
}

/* ================================
       INICIAR
================================*/
async function iniciar(){
  await carregarLanc();
  montarCards();
  graficoLinha();
  graficoCategorias();
  categoriasAumento();
  recorrencias();
}

iniciar();
</script>

</body>
</html>
