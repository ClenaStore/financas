<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --azul:#1F4E78;
  --azul-escuro:#12375A;
  --bg:#f4f6f9;
  --card:#ffffff;
  --radius:14px;
  --shadow:0 6px 20px rgba(0,0,0,0.15);
  --verde:#2ecc71;
  --vermelho:#e74c3c;
  --texto:#222;
}

/* GERAL */
body{
  margin:0;
  padding:25px;
  background:var(--bg);
  font-family:Arial;
}

h2{
  font-size:34px;
  margin-bottom:20px;
  color:var(--azul);
}

/* CARDS */
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.card{
  background:white;
  padding:25px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

.card h3{
  margin:0 0 10px 0;
  color:var(--azul-escuro);
}

.card .valor{
  font-size:28px;
  font-weight:bold;
}

/* GRÁFICOS */
.grafico-box{
  background:white;
  margin-top:30px;
  padding:25px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

/* LOADING */
#loading{
  position:fixed;
  inset:0;
  display:none;
  justify-content:center;
  align-items:center;
  background:rgba(255,255,255,0.7);
  font-size:26px;
  font-weight:bold;
  color:#333;
  z-index:999;
}

</style>
</head>

<body>

<div id="loading">Carregando...</div>

<h2>Dashboard Financeiro</h2>

<div class="cards">
  <div class="card">
    <h3>Receita Total</h3>
    <div id="receitaTotal" class="valor" style="color:var(--verde)">R$ 0,00</div>
  </div>
  <div class="card">
    <h3>Despesa Total</h3>
    <div id="despesaTotal" class="valor" style="color:var(--vermelho)">R$ 0,00</div>
  </div>
  <div class="card">
    <h3>Saldo Total</h3>
    <div id="saldoTotal" class="valor" style="color:var(--azul)">R$ 0,00</div>
  </div>
</div>

<div class="grafico-box">
  <h3>Receita × Despesa (Últimos 12 meses)</h3>
  <canvas id="graficoLinha"></canvas>
</div>

<div class="grafico-box">
  <h3>Totais por Categoria</h3>
  <canvas id="graficoCategorias"></canvas>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyInCpy_Ln1XQhcnbsfPHRimjx0frnOQDRgAyPtraKw_scr7uXP631SUyQZpIlUSi7IMA/exec";

function load(v){
  document.getElementById("loading").style.display = v ? "flex" : "none";
}

function fmt(v){
  return Number(v).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

let grafLinha, grafCat;

/* =================== DASHBOARD TOTAL ==================== */
async function carregarTotais(){
  let r = await fetch(API+"?action=dashboard");
  let dados = await r.json();

  let receita = dados.find(l=>l[0]==="receita_total")[1];
  let despesa = dados.find(l=>l[0]==="despesa_total")[1];
  let saldo = dados.find(l=>l[0]==="saldo_total")[1];

  document.getElementById("receitaTotal").innerText = fmt(receita);
  document.getElementById("despesaTotal").innerText = fmt(despesa);
  document.getElementById("saldoTotal").innerText = fmt(saldo);
}

/* =================== GRÁFICO LINHA ==================== */
async function carregarGraficoLinha(){
  let r = await fetch(API+"?action=fluxo");
  let dados = await r.json();

  let meses = [];
  let receitas = [];
  let despesas = [];

  dados.slice(1).forEach(l=>{
    meses.push(l[0]);
    receitas.push(l[1]);
    despesas.push(l[2]);
  });

  if(grafLinha) grafLinha.destroy();

  grafLinha = new Chart(document.getElementById("graficoLinha"),{
    type:"line",
    data:{
      labels:meses,
      datasets:[
        {
          label:"Receitas",
          data:receitas,
          borderColor:"#2ecc71",
          backgroundColor:"rgba(46,204,113,0.2)",
          fill:true,
          tension:0.3
        },
        {
          label:"Despesas",
          data:despesas,
          borderColor:"#e74c3c",
          backgroundColor:"rgba(231,76,60,0.2)",
          fill:true,
          tension:0.3
        }
      ]
    }
  });
}

/* =================== GRÁFICO CATEGORIAS ==================== */
async function carregarGraficoCategorias(){
  let r = await fetch(API+"?action=listLancamentos");
  let lanc = await r.json();

  let categorias = {};
  
  lanc.forEach(l=>{
    let tipo = l[2];
    let cat = l[3];
    let valor = Number(l[6]);

    if(!categorias[cat]) categorias[cat] = 0;

    categorias[cat] += tipo === "Despesa" ? -valor : valor;
  });

  let labels = Object.keys(categorias);
  let valores = Object.values(categorias);

  if(grafCat) grafCat.destroy();

  grafCat = new Chart(document.getElementById("graficoCategorias"),{
    type:"bar",
    data:{
      labels,
      datasets:[{
        label:"Valor",
        data:valores,
        backgroundColor: labels.map(v => 
          categorias[v] >= 0 
          ? "rgba(46,204,113,0.6)" 
          : "rgba(231,76,60,0.6)"
        ),
      }]
    }
  });
}

/* =================== INICIAR ==================== */
async function iniciar(){
  load(true);
  await carregarTotais();
  await carregarGraficoLinha();
  await carregarGraficoCategorias();
  load(false);
}

iniciar();

</script>

</body>
</html>
